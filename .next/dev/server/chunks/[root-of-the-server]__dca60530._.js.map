{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/connection.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  host: process.env.DB_HOST || 'localhost',\n  port: parseInt(process.env.DB_PORT || '5432'),\n  database: process.env.DB_NAME || 'cmsdb',\n  user: process.env.DB_USER || 'sk',\n  password: process.env.DB_PASSWORD || 'sk',\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n  process.exit(-1);\n});\n\nexport const query = async (text: string, params?: any[]) => {\n  const start = Date.now();\n  try {\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('Executed query', { text, duration, rows: res.rowCount });\n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n};\n\nexport const getClient = async (): Promise<PoolClient> => {\n  const client = await pool.connect();\n  return client;\n};\n\nexport default pool;\n"],"names":["Pool","PoolClient","pool","host","process","env","DB_HOST","port","parseInt","DB_PORT","database","DB_NAME","user","DB_USER","password","DB_PASSWORD","max","idleTimeoutMillis","connectionTimeoutMillis","on","err","console","error","exit","query","text","params","start","Date","now","res","duration","log","rows","rowCount","getClient","Promise","client","connect"],"mappings":";;;;;;;;AAAA,SAASA,IAAI,EAAEC,UAAU,QAAQ,IAAI;;;;;;AAErC,2BAAA;AACA,MAAMC,IAAI,GAAG,IAAIF,4GAAI,CAAC;IACpBG,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,OAAO,IAAI,WAAW;IACxCC,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAG,CAACI,OAAO,IAAI,MAAM,CAAC;IAC7CC,QAAQ,EAAEN,OAAO,CAACC,GAAG,CAACM,OAAO,IAAI,OAAO;IACxCC,IAAI,EAAER,OAAO,CAACC,GAAG,CAACQ,OAAO,IAAI,IAAI;IACjCC,QAAQ,EAAEV,OAAO,CAACC,GAAG,CAACU,WAAW,IAAI,IAAI;IACzCC,GAAG,EAAE,EAAE;IACPC,iBAAiB,EAAE,KAAK;IACxBC,uBAAuB,EAAE;AAC3B,CAAC,CAAC;AAEFhB,IAAI,CAACiB,EAAE,CAAC,OAAO,GAAGC,GAAG,IAAK;IACxBC,OAAO,CAACC,KAAK,CAAC,iCAAiC,EAAEF,GAAG,CAAC;IACrDhB,OAAO,CAACmB,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEK,MAAMC,KAAK,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,AAAgB,CAAP,EAAE,GAAG,EAAE,KAAK;IAC3D,MAAMC,KAAK,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC;IACxB,IAAI;QACF,MAAMC,GAAG,GAAG,MAAM5B,IAAI,CAACsB,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;QAC1C,MAAMK,QAAQ,GAAGH,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGF,KAAK;QACnCN,OAAO,CAACW,GAAG,CAAC,gBAAgB,EAAE;YAAEP,IAAI;YAAEM,QAAQ;YAAEE,IAAI,EAAEH,GAAG,CAACI,QAAAA;QAAS,CAAC,CAAC;QACrE,OAAOJ,GAAG;IACZ,CAAC,CAAC,OAAOR,KAAK,EAAE;QACdD,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC7C,MAAMA,KAAK;IACb;AACF,CAAC;AAEM,MAAMa,SAAS,GAAG,MAAAA,CAAA,CAAQ,EAAEC,OAAO,CAACnC,UAAU,CAAC,IAAI;IACxD,MAAMoC,MAAM,GAAG,MAAMnC,IAAI,CAACoC,OAAO,CAAC,CAAC;IACnC,OAAOD,MAAM;AACf,CAAC;uCAEcnC,IAAI","ignoreList":[],"debugId":null}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/productImages.ts"],"sourcesContent":["import { query } from './connection';\n\nexport interface ProductImage {\n  id: string;\n  product_id: string;\n  cloudflare_image_id: string;\n  filename?: string;\n  display_order: number;\n  is_primary: boolean;\n  created_at?: string;\n  updated_at?: string;\n}\n\n/**\n * Get all images for a product\n */\nexport async function getProductImages(productId: string): Promise<ProductImage[]> {\n  const result = await query(\n    'SELECT * FROM product_images WHERE product_id = $1 ORDER BY display_order ASC, created_at ASC',\n    [productId]\n  );\n  return result.rows;\n}\n\n/**\n * Add an image to a product\n */\nexport async function addProductImage(\n  productId: string,\n  cloudflareImageId: string,\n  filename?: string,\n  isPrimary: boolean = false,\n  displayOrder?: number\n): Promise<ProductImage> {\n  // If this is being set as primary, unset any existing primary images\n  if (isPrimary) {\n    await query(\n      'UPDATE product_images SET is_primary = false WHERE product_id = $1',\n      [productId]\n    );\n  }\n\n  // Get the next display order if not provided\n  if (displayOrder === undefined) {\n    const orderResult = await query(\n      'SELECT COALESCE(MAX(display_order), -1) + 1 as next_order FROM product_images WHERE product_id = $1',\n      [productId]\n    );\n    displayOrder = orderResult.rows[0].next_order;\n  }\n\n  const result = await query(\n    `INSERT INTO product_images (product_id, cloudflare_image_id, filename, is_primary, display_order)\n     VALUES ($1, $2, $3, $4, $5)\n     RETURNING *`,\n    [productId, cloudflareImageId, filename, isPrimary, displayOrder]\n  );\n\n  return result.rows[0];\n}\n\n/**\n * Delete a product image\n */\nexport async function deleteProductImage(imageId: string): Promise<boolean> {\n  const result = await query('DELETE FROM product_images WHERE id = $1', [imageId]);\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\n/**\n * Delete all images for a product\n */\nexport async function deleteAllProductImages(productId: string): Promise<boolean> {\n  const result = await query('DELETE FROM product_images WHERE product_id = $1', [productId]);\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\n/**\n * Set an image as primary\n */\nexport async function setPrimaryImage(productId: string, imageId: string): Promise<boolean> {\n  // Start a transaction\n  await query('BEGIN');\n\n  try {\n    // Unset all primary images for this product\n    await query(\n      'UPDATE product_images SET is_primary = false WHERE product_id = $1',\n      [productId]\n    );\n\n    // Set the specified image as primary\n    const result = await query(\n      'UPDATE product_images SET is_primary = true WHERE id = $1 AND product_id = $2',\n      [imageId, productId]\n    );\n\n    await query('COMMIT');\n\n    return result.rowCount ? result.rowCount > 0 : false;\n  } catch (error) {\n    await query('ROLLBACK');\n    throw error;\n  }\n}\n\n/**\n * Update image display order\n */\nexport async function updateImageOrder(\n  imageId: string,\n  newOrder: number\n): Promise<boolean> {\n  const result = await query(\n    'UPDATE product_images SET display_order = $1 WHERE id = $2',\n    [newOrder, imageId]\n  );\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\n/**\n * Get primary image for a product\n */\nexport async function getPrimaryImage(productId: string): Promise<ProductImage | null> {\n  const result = await query(\n    'SELECT * FROM product_images WHERE product_id = $1 AND is_primary = true',\n    [productId]\n  );\n  return result.rows[0] || null;\n}\n"],"names":["query","ProductImage","id","product_id","cloudflare_image_id","filename","display_order","is_primary","created_at","updated_at","getProductImages","productId","Promise","result","rows","addProductImage","cloudflareImageId","isPrimary","displayOrder","undefined","orderResult","next_order","deleteProductImage","imageId","rowCount","deleteAllProductImages","setPrimaryImage","error","updateImageOrder","newOrder","getPrimaryImage"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 266, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/cloudflare.ts"],"sourcesContent":["/**\n * Cloudflare R2 utility functions\n * Handles image uploads to Cloudflare R2 (S3-compatible storage)\n */\n\nimport { S3Client, PutObjectCommand, DeleteObjectCommand, HeadObjectCommand } from '@aws-sdk/client-s3';\nimport { Upload } from '@aws-sdk/lib-storage';\n\ninterface CloudflareUploadResponse {\n  success: boolean;\n  result?: {\n    id: string;\n    filename: string;\n    uploaded: string;\n    url: string;\n    key: string;\n  };\n  errors?: Array<{\n    code: number;\n    message: string;\n  }>;\n}\n\n/**\n * Get S3 client configured for Cloudflare R2\n */\nfunction getR2Client(): S3Client {\n  const accessKeyId = process.env.CLOUDFLARE_R2_ACCESS_KEY_ID;\n  const secretAccessKey = process.env.CLOUDFLARE_R2_SECRET_ACCESS_KEY;\n  const endpoint = process.env.CLOUDFLARE_R2_ENDPOINT;\n  const accountId = process.env.CLOUDFLARE_ACCOUNT_ID;\n\n  if (!accessKeyId || !secretAccessKey) {\n    throw new Error('R2 credentials not configured. Please check CLOUDFLARE_R2_ACCESS_KEY_ID and CLOUDFLARE_R2_SECRET_ACCESS_KEY in .env.local');\n  }\n\n  // Use provided endpoint or construct from account ID\n  const r2Endpoint = endpoint || `https://${accountId}.r2.cloudflarestorage.com`;\n\n  return new S3Client({\n    region: 'auto',\n    endpoint: r2Endpoint,\n    credentials: {\n      accessKeyId,\n      secretAccessKey,\n    },\n  });\n}\n\n/**\n * Generate a unique key for the file in R2\n */\nfunction generateFileKey(filename: string): string {\n  const folder = process.env.CLOUDFLARE_PRODUCT_IMAGE_FOLDER || 'product_images';\n  const timestamp = Date.now();\n  const randomString = Math.random().toString(36).substring(2, 15);\n  const sanitizedFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_');\n\n  return `${folder}/${timestamp}-${randomString}-${sanitizedFilename}`;\n}\n\n/**\n * Upload an image to Cloudflare R2\n * @param imageFile - File or Buffer to upload\n * @param filename - Name of the file\n * @returns Upload response with file key and URL\n */\nexport async function uploadImageToCloudflare(\n  imageFile: File | Buffer,\n  filename: string\n): Promise<CloudflareUploadResponse> {\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  if (!bucket) {\n    throw new Error('R2 bucket not configured. Please check CLOUDFLARE_BUCKET in .env.local');\n  }\n\n  const client = getR2Client();\n  const key = generateFileKey(filename);\n\n  try {\n    let fileBuffer: Buffer;\n    let contentType = 'image/jpeg';\n\n    // Convert File to Buffer if needed\n    if (imageFile instanceof File) {\n      contentType = imageFile.type || 'image/jpeg';\n      const arrayBuffer = await imageFile.arrayBuffer();\n      fileBuffer = Buffer.from(arrayBuffer);\n    } else {\n      fileBuffer = imageFile;\n      // Try to detect content type from filename\n      if (filename.endsWith('.png')) contentType = 'image/png';\n      else if (filename.endsWith('.gif')) contentType = 'image/gif';\n      else if (filename.endsWith('.webp')) contentType = 'image/webp';\n      else if (filename.endsWith('.svg')) contentType = 'image/svg+xml';\n    }\n\n    // Upload to R2 using S3 SDK\n    const upload = new Upload({\n      client,\n      params: {\n        Bucket: bucket,\n        Key: key,\n        Body: fileBuffer,\n        ContentType: contentType,\n      },\n    });\n\n    await upload.done();\n\n    const url = getCloudflareImageUrl(key);\n\n    return {\n      success: true,\n      result: {\n        id: key, // Use R2 key as ID\n        filename,\n        uploaded: new Date().toISOString(),\n        url,\n        key,\n      },\n    };\n  } catch (error: any) {\n    console.error('Error uploading to R2:', error);\n    throw error;\n  }\n}\n\n/**\n * Delete an image from Cloudflare R2\n * @param imageKey - R2 object key (not image ID)\n * @returns Success status\n */\nexport async function deleteImageFromCloudflare(\n  imageKey: string\n): Promise<boolean> {\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  if (!bucket) {\n    throw new Error('R2 bucket not configured');\n  }\n\n  const client = getR2Client();\n\n  try {\n    const command = new DeleteObjectCommand({\n      Bucket: bucket,\n      Key: imageKey,\n    });\n\n    await client.send(command);\n    return true;\n  } catch (error) {\n    console.error('Error deleting from R2:', error);\n    return false;\n  }\n}\n\n/**\n * Get the public URL for an R2 object\n * @param imageKey - R2 object key\n * @returns Public URL for the image\n */\nexport function getCloudflareImageUrl(imageKey: string): string {\n  const publicUrl = process.env.CLOUDFLARE_R2_PUBLIC_URL;\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  // If public URL is configured, use it\n  if (publicUrl && publicUrl !== 'https://pub-your-id.r2.dev') {\n    return `${publicUrl}/${imageKey}`;\n  }\n\n  // Otherwise, return a placeholder (user needs to configure public access)\n  // In production, you should either:\n  // 1. Enable public access on the bucket and set CLOUDFLARE_R2_PUBLIC_URL\n  // 2. Use signed URLs\n  // 3. Use a custom domain\n  return `https://r2-placeholder.com/${bucket}/${imageKey}`;\n}\n\n/**\n * Check if an image exists in R2\n * @param imageKey - R2 object key\n * @returns True if exists, false otherwise\n */\nexport async function imageExists(imageKey: string): Promise<boolean> {\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  if (!bucket) {\n    return false;\n  }\n\n  const client = getR2Client();\n\n  try {\n    const command = new HeadObjectCommand({\n      Bucket: bucket,\n      Key: imageKey,\n    });\n\n    await client.send(command);\n    return true;\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * Upload multiple images to Cloudflare R2\n * @param images - Array of {file, filename} objects\n * @returns Array of upload results\n */\nexport async function uploadMultipleImages(\n  images: Array<{ file: File | Buffer; filename: string }>\n): Promise<Array<{ success: boolean; imageId?: string; filename: string; error?: string; url?: string }>> {\n  const results = await Promise.allSettled(\n    images.map(({ file, filename }) => uploadImageToCloudflare(file, filename))\n  );\n\n  return results.map((result, index) => {\n    if (result.status === 'fulfilled' && result.value.success) {\n      return {\n        success: true,\n        imageId: result.value.result?.id,\n        filename: images[index].filename,\n        url: result.value.result?.url,\n      };\n    } else {\n      return {\n        success: false,\n        filename: images[index].filename,\n        error: result.status === 'rejected' ? result.reason?.message : 'Upload failed',\n      };\n    }\n  });\n}\n"],"names":["S3Client","PutObjectCommand","DeleteObjectCommand","HeadObjectCommand","Upload","CloudflareUploadResponse","success","result","id","filename","uploaded","url","key","errors","Array","code","message","getR2Client","accessKeyId","process","env","CLOUDFLARE_R2_ACCESS_KEY_ID","secretAccessKey","CLOUDFLARE_R2_SECRET_ACCESS_KEY","endpoint","CLOUDFLARE_R2_ENDPOINT","accountId","CLOUDFLARE_ACCOUNT_ID","Error","r2Endpoint","region","credentials","generateFileKey","folder","CLOUDFLARE_PRODUCT_IMAGE_FOLDER","timestamp","Date","now","randomString","Math","random","toString","substring","sanitizedFilename","replace","uploadImageToCloudflare","imageFile","File","Buffer","Promise","bucket","CLOUDFLARE_BUCKET","client","fileBuffer","contentType","type","arrayBuffer","from","endsWith","upload","params","Bucket","Key","Body","ContentType","done","getCloudflareImageUrl","toISOString","error","console","deleteImageFromCloudflare","imageKey","command","send","publicUrl","CLOUDFLARE_R2_PUBLIC_URL","imageExists","uploadMultipleImages","images","file","imageId","results","allSettled","map","index","status","value","reason"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 441, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/products.ts"],"sourcesContent":["import { query } from './connection';\nimport { getProductImages } from './productImages';\nimport { getCloudflareImageUrl } from '../cloudflare';\n\nexport interface Product {\n  id: string;\n  name: string;\n  description: string;\n  price: number;\n  image_url?: string;\n  category?: string;\n  slug?: string;\n  stock_quantity?: number;\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface ProductWithImages extends Product {\n  images: Array<{\n    id: string;\n    url: string;\n    cloudflare_image_id: string;\n    is_primary: boolean;\n    display_order: number;\n  }>;\n  primary_image?: string;\n}\n\nexport async function getProducts(filters: {\n  search?: string;\n  category?: string;\n  minPrice?: number;\n  maxPrice?: number;\n  page?: number;\n  limit?: number;\n}) {\n  const page = filters.page || 1;\n  const limit = filters.limit || 12;\n  const offset = (page - 1) * limit;\n\n  let whereConditions: string[] = [];\n  let params: any[] = [];\n  let paramCount = 1;\n\n  if (filters.search) {\n    whereConditions.push(`(name ILIKE $${paramCount} OR description ILIKE $${paramCount})`);\n    params.push(`%${filters.search}%`);\n    paramCount++;\n  }\n\n  if (filters.category) {\n    whereConditions.push(`category = $${paramCount}`);\n    params.push(filters.category);\n    paramCount++;\n  }\n\n  if (filters.minPrice !== undefined && filters.minPrice !== null) {\n    whereConditions.push(`price >= $${paramCount}`);\n    params.push(filters.minPrice);\n    paramCount++;\n  }\n\n  if (filters.maxPrice !== undefined && filters.maxPrice !== null) {\n    whereConditions.push(`price <= $${paramCount}`);\n    params.push(filters.maxPrice);\n    paramCount++;\n  }\n\n  const whereClause = whereConditions.length > 0 ? 'WHERE ' + whereConditions.join(' AND ') : '';\n\n  // Get products\n  const productsQuery = `\n    SELECT * FROM products\n    ${whereClause}\n    ORDER BY created_at DESC\n    LIMIT $${paramCount} OFFSET $${paramCount + 1}\n  `;\n  params.push(limit, offset);\n\n  const productsResult = await query(productsQuery, params);\n\n  // Get total count\n  const countQuery = `SELECT COUNT(*) as count FROM products ${whereClause}`;\n  const countResult = await query(countQuery, params.slice(0, paramCount - 1));\n  const total = parseInt(countResult.rows[0].count);\n\n  return {\n    products: productsResult.rows,\n    pagination: {\n      page,\n      limit,\n      total,\n      pages: Math.ceil(total / limit),\n      hasMore: page < Math.ceil(total / limit),\n    },\n  };\n}\n\nexport async function getProductById(id: string): Promise<Product | null> {\n  const result = await query('SELECT * FROM products WHERE id = $1', [id]);\n  return result.rows[0] || null;\n}\n\nexport async function getProductBySlug(slug: string): Promise<Product | null> {\n  const result = await query('SELECT * FROM products WHERE slug = $1', [slug]);\n  return result.rows[0] || null;\n}\n\nexport async function createProduct(product: {\n  name: string;\n  description: string;\n  price: number;\n  image_url?: string;\n  category?: string;\n  slug: string;\n  stock_quantity?: number;\n}): Promise<Product> {\n  const result = await query(\n    `INSERT INTO products (name, description, price, image_url, category, slug, stock_quantity)\n     VALUES ($1, $2, $3, $4, $5, $6, $7)\n     RETURNING *`,\n    [\n      product.name,\n      product.description,\n      product.price,\n      product.image_url,\n      product.category,\n      product.slug,\n      product.stock_quantity || 0,\n    ]\n  );\n  return result.rows[0];\n}\n\nexport async function updateProduct(\n  id: string,\n  updates: Partial<Product>\n): Promise<Product | null> {\n  const fields: string[] = [];\n  const values: any[] = [];\n  let paramCount = 1;\n\n  Object.entries(updates).forEach(([key, value]) => {\n    if (value !== undefined) {\n      fields.push(`${key} = $${paramCount++}`);\n      values.push(value);\n    }\n  });\n\n  if (fields.length === 0) {\n    return getProductById(id);\n  }\n\n  values.push(id);\n\n  const result = await query(\n    `UPDATE products SET ${fields.join(', ')}, updated_at = NOW() WHERE id = $${paramCount} RETURNING *`,\n    values\n  );\n\n  return result.rows[0] || null;\n}\n\nexport async function deleteProduct(id: string): Promise<boolean> {\n  const result = await query('DELETE FROM products WHERE id = $1', [id]);\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\nexport async function searchProducts(searchTerm: string, limit: number = 10) {\n  const result = await query(\n    `SELECT * FROM products\n     WHERE name ILIKE $1 OR description ILIKE $1\n     ORDER BY created_at DESC\n     LIMIT $2`,\n    [`%${searchTerm}%`, limit]\n  );\n  return result.rows;\n}\n\n/**\n * Get a product with its images from Cloudflare\n */\nexport async function getProductWithImages(id: string): Promise<ProductWithImages | null> {\n  const product = await getProductById(id);\n  if (!product) return null;\n\n  const images = await getProductImages(id);\n  const imagesWithUrls = images.map((img) => ({\n    id: img.id,\n    url: getCloudflareImageUrl(img.cloudflare_image_id),\n    cloudflare_image_id: img.cloudflare_image_id,\n    is_primary: img.is_primary,\n    display_order: img.display_order,\n  }));\n\n  const primaryImage = imagesWithUrls.find((img) => img.is_primary);\n\n  return {\n    ...product,\n    images: imagesWithUrls,\n    primary_image: primaryImage?.url || product.image_url,\n  };\n}\n\n/**\n * Get a product by slug with its images\n */\nexport async function getProductBySlugWithImages(slug: string): Promise<ProductWithImages | null> {\n  const product = await getProductBySlug(slug);\n  if (!product) return null;\n\n  const images = await getProductImages(product.id);\n  const imagesWithUrls = images.map((img) => ({\n    id: img.id,\n    url: getCloudflareImageUrl(img.cloudflare_image_id),\n    cloudflare_image_id: img.cloudflare_image_id,\n    is_primary: img.is_primary,\n    display_order: img.display_order,\n  }));\n\n  const primaryImage = imagesWithUrls.find((img) => img.is_primary);\n\n  return {\n    ...product,\n    images: imagesWithUrls,\n    primary_image: primaryImage?.url || product.image_url,\n  };\n}\n\n/**\n * Get products with their images\n */\nexport async function getProductsWithImages(filters: {\n  search?: string;\n  category?: string;\n  minPrice?: number;\n  maxPrice?: number;\n  page?: number;\n  limit?: number;\n}) {\n  const result = await getProducts(filters);\n\n  // Fetch images for all products\n  const productsWithImages = await Promise.all(\n    result.products.map(async (product) => {\n      const images = await getProductImages(product.id);\n      const imagesWithUrls = images.map((img) => ({\n        id: img.id,\n        url: getCloudflareImageUrl(img.cloudflare_image_id),\n        cloudflare_image_id: img.cloudflare_image_id,\n        is_primary: img.is_primary,\n        display_order: img.display_order,\n      }));\n\n      const primaryImage = imagesWithUrls.find((img) => img.is_primary);\n\n      return {\n        ...product,\n        images: imagesWithUrls,\n        primary_image: primaryImage?.url || product.image_url,\n      };\n    })\n  );\n\n  return {\n    products: productsWithImages,\n    pagination: result.pagination,\n  };\n}\n"],"names":["query","getProductImages","getCloudflareImageUrl","Product","id","name","description","price","image_url","category","slug","stock_quantity","created_at","updated_at","ProductWithImages","images","Array","url","cloudflare_image_id","is_primary","display_order","primary_image","getProducts","filters","search","minPrice","maxPrice","page","limit","offset","whereConditions","params","paramCount","push","undefined","whereClause","length","join","productsQuery","productsResult","countQuery","countResult","slice","total","parseInt","rows","count","products","pagination","pages","Math","ceil","hasMore","getProductById","Promise","result","getProductBySlug","createProduct","product","updateProduct","updates","Partial","fields","values","Object","entries","forEach","key","value","deleteProduct","rowCount","searchProducts","searchTerm","getProductWithImages","imagesWithUrls","map","img","primaryImage","find","getProductBySlugWithImages","getProductsWithImages","productsWithImages","all"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 652, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/search/products/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getProductsWithImages } from '@/lib/db/products';\n\n// Handle preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return NextResponse.json({}, {\n    headers: {\n      \"Access-Control-Allow-Credentials\": \"true\",\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n      \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n    },\n  });\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const search = searchParams.get('q') || searchParams.get('search') || '';\n    const category = searchParams.get('category') || '';\n    const minPrice = searchParams.get('minPrice')\n      ? parseFloat(searchParams.get('minPrice')!)\n      : undefined;\n    const maxPrice = searchParams.get('maxPrice')\n      ? parseFloat(searchParams.get('maxPrice')!)\n      : undefined;\n    const page = parseInt(searchParams.get('page') || '1');\n    const limit = parseInt(searchParams.get('limit') || '12');\n\n    const result = await getProductsWithImages({\n      search,\n      category,\n      minPrice,\n      maxPrice,\n      page,\n      limit,\n    });\n\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          products: result.products,\n          pagination: result.pagination,\n          filters: {\n            search,\n            category,\n            minPrice,\n            maxPrice,\n          },\n        },\n      },\n      {\n        headers: {\n          'Access-Control-Allow-Credentials': 'true',\n          'Access-Control-Allow-Origin': '*',\n          'Access-Control-Allow-Methods': 'GET,DELETE,PATCH,POST,PUT,OPTIONS',\n          'Access-Control-Allow-Headers':\n            'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization',\n        },\n      }\n    );\n  } catch (error) {\n    console.error('Error searching products:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error',\n      },\n      {\n        status: 500,\n        headers: {\n          'Access-Control-Allow-Credentials': 'true',\n          'Access-Control-Allow-Origin': '*',\n          'Access-Control-Allow-Methods': 'GET,DELETE,PATCH,POST,PUT,OPTIONS',\n          'Access-Control-Allow-Headers':\n            'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization',\n        },\n      }\n    );\n  }\n}"],"names":["NextRequest","NextResponse","getProductsWithImages","OPTIONS","request","json","headers","GET","searchParams","URL","url","search","get","category","minPrice","parseFloat","undefined","maxPrice","page","parseInt","limit","result","success","data","products","pagination","filters","error","console","status"],"mappings":";;;;;;AAAA,SAASA,WAAW,EAAEC,YAAY,QAAQ,aAAa;AACvD,SAASC,qBAAqB,QAAQ,mBAAmB;;;;;;;AAGlD,eAAeC,OAAOA,CAACC,OAAO,AAAa,EAAXJ,AAAa;IAClD,OAAOC,gJAAY,CAACI,IAAI,CAAC,CAAC,CAAC,EAAE;QAC3BC,OAAO,EAAE;YACP,kCAAkC,EAAE,MAAM;YAC1C,6BAA6B,EAAE,GAAG;YAClC,8BAA8B,EAAE,mCAAmC;YACnE,8BAA8B,EAAE;QAClC;IACF,CAAC,CAAC;AACJ;AAEO,eAAeC,GAAGA,CAACH,OAAoB,AAAb,EAAe,AAAbJ;IACjC,IAAI;QACF,MAAM,EAAEQ,YAAAA,EAAc,GAAG,IAAIC,GAAG,CAACL,OAAO,CAACM,GAAG,CAAC;QAC7C,MAAMC,MAAM,GAAGH,YAAY,CAACI,GAAG,CAAC,GAAG,CAAC,IAAIJ,YAAY,CAACI,GAAG,CAAC,QAAQ,CAAC,IAAI,EAAE;QACxE,MAAMC,QAAQ,GAAGL,YAAY,CAACI,GAAG,CAAC,UAAU,CAAC,IAAI,EAAE;QACnD,MAAME,QAAQ,GAAGN,YAAY,CAACI,GAAG,CAAC,UAAU,CAAC,GACzCG,UAAU,CAACP,YAAY,CAACI,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,EACzCI,SAAS;QACb,MAAMC,QAAQ,GAAGT,YAAY,CAACI,GAAG,CAAC,UAAU,CAAC,GACzCG,UAAU,CAACP,YAAY,CAACI,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,EACzCI,SAAS;QACb,MAAME,IAAI,GAAGC,QAAQ,CAACX,YAAY,CAACI,GAAG,CAAC,MAAM,CAAC,IAAI,GAAG,CAAC;QACtD,MAAMQ,KAAK,GAAGD,QAAQ,CAACX,YAAY,CAACI,GAAG,CAAC,OAAO,CAAC,IAAI,IAAI,CAAC;QAEzD,MAAMS,MAAM,GAAG,UAAMnB,uJAAqB,EAAC;YACzCS,MAAM;YACNE,QAAQ;YACRC,QAAQ;YACRG,QAAQ;YACRC,IAAI;YACJE;QACF,CAAC,CAAC;QAEF,OAAOnB,gJAAY,CAACI,IAAI,CACtB;YACEiB,OAAO,EAAE,IAAI;YACbC,IAAI,EAAE;gBACJC,QAAQ,EAAEH,MAAM,CAACG,QAAQ;gBACzBC,UAAU,EAAEJ,MAAM,CAACI,UAAU;gBAC7BC,OAAO,EAAE;oBACPf,MAAM;oBACNE,QAAQ;oBACRC,QAAQ;oBACRG;gBACF;YACF;QACF,CAAC,EACD;YACEX,OAAO,EAAE;gBACP,kCAAkC,EAAE,MAAM;gBAC1C,6BAA6B,EAAE,GAAG;gBAClC,8BAA8B,EAAE,mCAAmC;gBACnE,8BAA8B,EAC5B;YACJ;QACF,CACF,CAAC;IACH,CAAC,CAAC,OAAOqB,KAAK,EAAE;QACdC,OAAO,CAACD,KAAK,CAAC,2BAA2B,EAAEA,KAAK,CAAC;QACjD,OAAO1B,gJAAY,CAACI,IAAI,CACtB;YACEiB,OAAO,EAAE,KAAK;YACdK,KAAK,EAAE;QACT,CAAC,EACD;YACEE,MAAM,EAAE,GAAG;YACXvB,OAAO,EAAE;gBACP,kCAAkC,EAAE,MAAM;gBAC1C,6BAA6B,EAAE,GAAG;gBAClC,8BAA8B,EAAE,mCAAmC;gBACnE,8BAA8B,EAC5B;YACJ;QACF,CACF,CAAC;IACH;AACF","ignoreList":[],"debugId":null}}]
}