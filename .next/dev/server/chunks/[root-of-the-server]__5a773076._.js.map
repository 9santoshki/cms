{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/connection.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  host: process.env.DB_HOST || 'localhost',\n  port: parseInt(process.env.DB_PORT || '5432'),\n  database: process.env.DB_NAME || 'cmsdb',\n  user: process.env.DB_USER || 'sk',\n  password: process.env.DB_PASSWORD || 'sk',\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n  process.exit(-1);\n});\n\nexport const query = async (text: string, params?: any[]) => {\n  try {\n    const res = await pool.query(text, params);\n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n};\n\nexport const getClient = async (): Promise<PoolClient> => {\n  const client = await pool.connect();\n  return client;\n};\n\nexport default pool;\n"],"names":["Pool","PoolClient","pool","host","process","env","DB_HOST","port","parseInt","DB_PORT","database","DB_NAME","user","DB_USER","password","DB_PASSWORD","max","idleTimeoutMillis","connectionTimeoutMillis","on","err","console","error","exit","query","text","params","res","getClient","Promise","client","connect"],"mappings":";;;;;;;;AAAA,SAASA,IAAI,EAAEC,UAAU,QAAQ,IAAI;;;;;;AAErC,2BAAA;AACA,MAAMC,IAAI,GAAG,IAAIF,4GAAI,CAAC;IACpBG,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,OAAO,IAAI,WAAW;IACxCC,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAG,CAACI,OAAO,IAAI,MAAM,CAAC;IAC7CC,QAAQ,EAAEN,OAAO,CAACC,GAAG,CAACM,OAAO,IAAI,OAAO;IACxCC,IAAI,EAAER,OAAO,CAACC,GAAG,CAACQ,OAAO,IAAI,IAAI;IACjCC,QAAQ,EAAEV,OAAO,CAACC,GAAG,CAACU,WAAW,IAAI,IAAI;IACzCC,GAAG,EAAE,EAAE;IACPC,iBAAiB,EAAE,KAAK;IACxBC,uBAAuB,EAAE;AAC3B,CAAC,CAAC;AAEFhB,IAAI,CAACiB,EAAE,CAAC,OAAO,GAAGC,GAAG,IAAK;IACxBC,OAAO,CAACC,KAAK,CAAC,iCAAiC,EAAEF,GAAG,CAAC;IACrDhB,OAAO,CAACmB,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEK,MAAMC,KAAK,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,AAAgB,CAAP,EAAE,GAAG,EAAE,KAAK;IAC3D,IAAI;QACF,MAAMC,GAAG,GAAG,MAAMzB,IAAI,CAACsB,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;QAC1C,OAAOC,GAAG;IACZ,CAAC,CAAC,OAAOL,KAAK,EAAE;QACdD,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC7C,MAAMA,KAAK;IACb;AACF,CAAC;AAEM,MAAMM,SAAS,GAAG,MAAAA,CAAA,CAAQ,EAAEC,OAAO,CAAC5B,UAAU,CAAC,IAAI;IACxD,MAAM6B,MAAM,GAAG,MAAM5B,IAAI,CAAC6B,OAAO,CAAC,CAAC;IACnC,OAAOD,MAAM;AACf,CAAC;uCAEc5B,IAAI","ignoreList":[],"debugId":null}},
    {"offset": {"line": 132, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/auth.ts"],"sourcesContent":["import { query } from './connection';\nimport { cookies, headers } from 'next/headers';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\nconst SESSION_COOKIE_NAME = 'cms-session';\nconst SESSION_DURATION_DAYS = 30; // 30 days for persistent login\n\nexport interface UserProfile {\n  id: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: 'customer' | 'moderator' | 'admin';\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface SessionData {\n  userId: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: string;\n  sessionId?: string; // Database session ID\n}\n\nexport interface DBSession {\n  id: string;\n  user_id: string;\n  session_token: string;\n  refresh_token?: string;\n  user_agent?: string;\n  ip_address?: string;\n  expires_at: string;\n  created_at: string;\n  updated_at: string;\n  last_activity: string;\n}\n\n// Create or update user from Google OAuth\nexport const upsertUserFromGoogle = async (googleUser: {\n  id: string;\n  email: string;\n  name: string;\n  picture?: string;\n}): Promise<UserProfile> => {\n  // Check if user exists\n  const existingUser = await query(\n    'SELECT * FROM users WHERE email = $1',\n    [googleUser.email]\n  );\n\n  let userId: string;\n\n  if (existingUser.rows.length > 0) {\n    // Update existing user\n    userId = existingUser.rows[0].id;\n    await query(\n      `UPDATE users\n       SET name = $1, avatar = $2, google_id = $3, updated_at = NOW()\n       WHERE id = $4`,\n      [googleUser.name, googleUser.picture, googleUser.id, userId]\n    );\n  } else {\n    // Create new user\n    const newUser = await query(\n      `INSERT INTO users (email, name, avatar, google_id, role)\n       VALUES ($1, $2, $3, $4, 'customer')\n       RETURNING id`,\n      [googleUser.email, googleUser.name, googleUser.picture, googleUser.id]\n    );\n    userId = newUser.rows[0].id;\n  }\n\n  // Get the complete user profile\n  const userProfile = await getUserProfile(userId);\n  if (!userProfile) {\n    throw new Error('Failed to create or fetch user profile');\n  }\n\n  return userProfile;\n};\n\n// Get user profile by ID\nexport const getUserProfile = async (userId: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE id = $1',\n    [userId]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Get user profile by email\nexport const getUserByEmail = async (email: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE email = $1',\n    [email]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Create session token\nexport const createSessionToken = (user: UserProfile): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: '7d' });\n};\n\n// Verify session token\nexport const verifySessionToken = (token: string): SessionData | null => {\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as SessionData;\n    return decoded;\n  } catch (error) {\n    console.error('Invalid token:', error);\n    return null;\n  }\n};\n\n// Set session cookie\nexport const setSessionCookie = async (token: string) => {\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7, // 7 days\n    path: '/',\n  });\n};\n\n// Get session from cookie\nexport const getSessionFromCookie = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  return verifySessionToken(sessionCookie.value);\n};\n\n// Clear session cookie\nexport const clearSessionCookie = async () => {\n  const cookieStore = await cookies();\n  cookieStore.delete(SESSION_COOKIE_NAME);\n};\n\n// Update user role (admin only)\nexport const updateUserRole = async (\n  userId: string,\n  newRole: 'customer' | 'moderator' | 'admin'\n): Promise<void> => {\n  await query(\n    'UPDATE users SET role = $1, updated_at = NOW() WHERE id = $2',\n    [newRole, userId]\n  );\n};\n\n// Get all user profiles (admin only)\nexport const getAllUserProfiles = async (): Promise<UserProfile[]> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users ORDER BY created_at DESC'\n  );\n\n  return result.rows;\n};\n\n// Update user profile\nexport const updateUserProfile = async (\n  userId: string,\n  updates: { name?: string; avatar?: string }\n): Promise<UserProfile | null> => {\n  const fields: string[] = [];\n  const values: any[] = [];\n  let paramCount = 1;\n\n  if (updates.name !== undefined) {\n    fields.push(`name = $${paramCount++}`);\n    values.push(updates.name);\n  }\n\n  if (updates.avatar !== undefined) {\n    fields.push(`avatar = $${paramCount++}`);\n    values.push(updates.avatar);\n  }\n\n  if (fields.length === 0) {\n    return getUserProfile(userId);\n  }\n\n  fields.push(`updated_at = NOW()`);\n  values.push(userId);\n\n  await query(\n    `UPDATE users SET ${fields.join(', ')} WHERE id = $${paramCount}`,\n    values\n  );\n\n  return getUserProfile(userId);\n};\n\n// ============================================================================\n// SESSION MANAGEMENT (Database-backed persistent sessions)\n// ============================================================================\n\n// Generate secure random token\nconst generateSecureToken = (): string => {\n  return crypto.randomBytes(32).toString('hex');\n};\n\n// Get request metadata (user agent, IP)\nconst getRequestMetadata = async () => {\n  try {\n    const headersList = await headers();\n    const userAgent = (await headersList).get('user-agent') || undefined;\n    const forwardedFor = (await headersList).get('x-forwarded-for');\n    const realIp = (await headersList).get('x-real-ip');\n    const ipAddress = forwardedFor?.split(',')[0] || realIp || undefined;\n\n    return { userAgent, ipAddress };\n  } catch (error) {\n    return { userAgent: undefined, ipAddress: undefined };\n  }\n};\n\n// Create a new session in the database\nexport const createSession = async (\n  user: UserProfile,\n  rememberMe: boolean = true\n): Promise<{ sessionToken: string; refreshToken: string; dbSession: DBSession }> => {\n  const sessionToken = generateSecureToken();\n  const refreshToken = generateSecureToken();\n  const { userAgent, ipAddress } = await getRequestMetadata();\n\n  // Calculate expiration based on remember me option\n  const durationDays = rememberMe ? SESSION_DURATION_DAYS : 1; // 30 days or 1 day\n  const expiresAt = new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000);\n\n  const result = await query(\n    `INSERT INTO sessions (user_id, session_token, refresh_token, user_agent, ip_address, expires_at)\n     VALUES ($1, $2, $3, $4, $5, $6)\n     RETURNING *`,\n    [user.id, sessionToken, refreshToken, userAgent, ipAddress, expiresAt]\n  );\n\n  return {\n    sessionToken,\n    refreshToken,\n    dbSession: result.rows[0]\n  };\n};\n\n// Get session from database by token\nexport const getSessionFromDB = async (sessionToken: string): Promise<DBSession | null> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE session_token = $1\n     AND expires_at > NOW()`,\n    [sessionToken]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Update session activity timestamp\nexport const updateSessionActivity = async (sessionId: string): Promise<void> => {\n  await query(\n    'UPDATE sessions SET last_activity = NOW() WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Delete a specific session\nexport const deleteSession = async (sessionToken: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE session_token = $1',\n    [sessionToken]\n  );\n};\n\n// Delete all sessions for a user\nexport const deleteUserSessions = async (userId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE user_id = $1',\n    [userId]\n  );\n};\n\n// Delete a specific session by ID\nexport const deleteSessionById = async (sessionId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Clean up expired sessions\nexport const cleanupExpiredSessions = async (): Promise<number> => {\n  const result = await query('SELECT cleanup_expired_sessions()');\n  return result.rows[0].cleanup_expired_sessions;\n};\n\n// Get all active sessions for a user\nexport const getUserSessions = async (userId: string): Promise<DBSession[]> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE user_id = $1\n     AND expires_at > NOW()\n     ORDER BY last_activity DESC`,\n    [userId]\n  );\n\n  return result.rows;\n};\n\n// Enhanced session token creation with database session ID\nexport const createSessionTokenWithDB = (user: UserProfile, sessionId: string): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n    sessionId: sessionId, // Include DB session ID in JWT\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: `${SESSION_DURATION_DAYS}d` });\n};\n\n// Enhanced session validation (checks both JWT and database)\nexport const validateSession = async (token: string): Promise<SessionData | null> => {\n  // First verify JWT\n  const jwtData = verifySessionToken(token);\n  if (!jwtData) {\n    return null;\n  }\n\n  // If JWT has session ID, verify against database\n  if (jwtData.sessionId) {\n    const dbSession = await query(\n      'SELECT * FROM sessions WHERE id = $1 AND expires_at > NOW()',\n      [jwtData.sessionId]\n    );\n\n    if (dbSession.rows.length === 0) {\n      // Session was invalidated in database\n      return null;\n    }\n\n    // Update last activity\n    await updateSessionActivity(jwtData.sessionId);\n  }\n\n  return jwtData;\n};\n\n// Enhanced get session from cookie with database validation\nexport const getSessionFromCookieWithDB = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  // Validate against database as well\n  return validateSession(sessionCookie.value);\n};\n\n// Enhanced set session cookie with longer duration\nexport const setSessionCookieWithDB = async (token: string, rememberMe: boolean = true) => {\n  const cookieStore = await cookies();\n  const maxAge = rememberMe\n    ? 60 * 60 * 24 * SESSION_DURATION_DAYS  // 30 days\n    : 60 * 60 * 24; // 1 day\n\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: maxAge,\n    path: '/',\n  });\n};\n\n// Enhanced logout that clears both cookie and database session\nexport const logoutSession = async (): Promise<void> => {\n  const session = await getSessionFromCookieWithDB();\n\n  // Clear cookie\n  await clearSessionCookie();\n\n  // Delete from database if session ID exists\n  if (session?.sessionId) {\n    await deleteSessionById(session.sessionId);\n  }\n};\n"],"names":["query","cookies","headers","jwt","crypto","JWT_SECRET","process","env","SESSION_COOKIE_NAME","SESSION_DURATION_DAYS","UserProfile","id","email","name","avatar","role","created_at","updated_at","SessionData","userId","sessionId","DBSession","user_id","session_token","refresh_token","user_agent","ip_address","expires_at","last_activity","upsertUserFromGoogle","googleUser","picture","Promise","existingUser","rows","length","newUser","userProfile","getUserProfile","Error","result","getUserByEmail","createSessionToken","user","sessionData","sign","expiresIn","verifySessionToken","token","decoded","verify","error","console","setSessionCookie","cookieStore","set","httpOnly","secure","NODE_ENV","sameSite","maxAge","path","getSessionFromCookie","sessionCookie","get","value","clearSessionCookie","delete","updateUserRole","newRole","getAllUserProfiles","updateUserProfile","updates","fields","values","paramCount","undefined","push","join","generateSecureToken","randomBytes","toString","getRequestMetadata","headersList","userAgent","forwardedFor","realIp","ipAddress","split","createSession","rememberMe","sessionToken","refreshToken","dbSession","durationDays","expiresAt","Date","now","getSessionFromDB","updateSessionActivity","deleteSession","deleteUserSessions","deleteSessionById","cleanupExpiredSessions","cleanup_expired_sessions","getUserSessions","createSessionTokenWithDB","validateSession","jwtData","getSessionFromCookieWithDB","setSessionCookieWithDB","logoutSession","session"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 488, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/cart.ts"],"sourcesContent":["import { query } from './connection';\n\nexport interface CartItem {\n  id: string;\n  user_id: string;\n  product_id: string;\n  quantity: number;\n  created_at?: string;\n  updated_at?: string;\n  // Joined product data\n  name?: string;\n  price?: number;\n  image_url?: string;\n}\n\nexport async function getCartItems(userId: string): Promise<CartItem[]> {\n  const result = await query(\n    `SELECT\n      ci.id,\n      ci.user_id,\n      ci.product_id,\n      ci.quantity,\n      p.name,\n      p.description,\n      p.price,\n      p.image_url,\n      (\n        SELECT pi.cloudflare_image_id\n        FROM product_images pi\n        WHERE pi.product_id = p.id AND pi.is_primary = true\n        LIMIT 1\n      ) as primary_image_id\n     FROM cart_items ci\n     JOIN products p ON ci.product_id = p.id\n     WHERE ci.user_id = $1::uuid\n     ORDER BY ci.created_at DESC`,\n    [userId]\n  );\n  return result.rows;\n}\n\nexport async function getCartItem(userId: string, productId: string): Promise<CartItem | null> {\n  const result = await query(\n    `SELECT * FROM cart_items WHERE user_id = $1::uuid AND product_id = $2::uuid`,\n    [userId, productId]\n  );\n  return result.rows[0] || null;\n}\n\nexport async function addCartItem(\n  userId: string,\n  productId: string,\n  quantity: number\n): Promise<CartItem> {\n  const result = await query(\n    `INSERT INTO cart_items (user_id, product_id, quantity)\n     VALUES ($1::uuid, $2::uuid, $3)\n     ON CONFLICT (user_id, product_id)\n     DO UPDATE SET quantity = cart_items.quantity + $3, updated_at = NOW()\n     RETURNING *`,\n    [userId, productId, quantity]\n  );\n  return result.rows[0];\n}\n\nexport async function updateCartItemQuantity(\n  userId: string,\n  productId: string,\n  quantity: number\n): Promise<CartItem | null> {\n  const result = await query(\n    `UPDATE cart_items\n     SET quantity = $3, updated_at = NOW()\n     WHERE user_id = $1::uuid AND product_id = $2::uuid\n     RETURNING *`,\n    [userId, productId, quantity]\n  );\n  return result.rows[0] || null;\n}\n\nexport async function removeCartItem(userId: string, productId: string): Promise<boolean> {\n  const result = await query(\n    `DELETE FROM cart_items WHERE user_id = $1::uuid AND product_id = $2::uuid`,\n    [userId, productId]\n  );\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\nexport async function clearCart(userId: string): Promise<boolean> {\n  const result = await query(`DELETE FROM cart_items WHERE user_id = $1::uuid`, [userId]);\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\nexport async function getCartItemWithProduct(\n  userId: string,\n  productId: string\n): Promise<CartItem | null> {\n  const result = await query(\n    `SELECT\n      ci.id,\n      ci.product_id,\n      ci.quantity,\n      p.name,\n      p.price,\n      p.image_url\n     FROM cart_items ci\n     JOIN products p ON ci.product_id = p.id\n     WHERE ci.user_id = $1::uuid AND ci.product_id = $2::uuid`,\n    [userId, productId]\n  );\n  return result.rows[0] || null;\n}\n"],"names":["query","CartItem","id","user_id","product_id","quantity","created_at","updated_at","name","price","image_url","getCartItems","userId","Promise","result","rows","getCartItem","productId","addCartItem","updateCartItemQuantity","removeCartItem","rowCount","clearCart","getCartItemWithProduct"],"mappings":";;;;;;;;;;;;;;;;AAAA,SAASA,KAAK,QAAQ,cAAc;;;;;;AAe7B,eAAeW,YAAYA,CAACC,MAAM,AAAQ,CAAC,CAAP,CAASC,OAAO,CAACZ,QAAQ,EAAE,CAAC,CAAC;IACtE,MAAMa,MAAM,GAAG,UAAMd,yIAAK,EACxB,CAAA;;;;;;;;;;;;;;;;;;gCAkBJ,CAAiC,EAC7B;QAACY,MAAM;KACT,CAAC;IACD,OAAOE,MAAM,CAACC,IAAI;AACpB;AAEO,eAAeC,WAAWA,CAACJ,MAAM,AAAQ,EAAN,AAAQK,SAAS,AAAQ,CAAC,CAAP,CAASJ,OAAO,CAACZ,QAAQ,GAAG,IAAI,CAAC,CAAC;IAC7F,MAAMa,MAAM,GAAG,UAAMd,yIAAK,EACxB,CAAA,2EAAA,CAA6E,EAC7E;QAACY,MAAM;QAAEK,SAAS;KACpB,CAAC;IACD,OAAOH,MAAM,CAACC,IAAI,CAAC,CAAC,CAAC,IAAI,IAAI;AAC/B;AAEO,eAAeG,WAAWA,CAC/BN,MAAM,AAAQ,EAAN,AACRK,SAAS,AAAQ,EAAN,AACXZ,QAAQ,AAAQ,CACjB,CADW,CACTQ,OAAO,CAACZ,QAAQ,CAAC,CAAC;IACnB,MAAMa,MAAM,GAAG,UAAMd,yIAAK,EACxB,CAAA;;;;gBAIJ,CAAiB,EACb;QAACY,MAAM;QAAEK,SAAS;QAAEZ,QAAQ;KAC9B,CAAC;IACD,OAAOS,MAAM,CAACC,IAAI,CAAC,CAAC,CAAC;AACvB;AAEO,eAAeI,sBAAsBA,CAC1CP,MAAM,AAAQ,EAAN,AACRK,SAAS,AAAQ,EACjBZ,AADW,QACH,AAAQ,CACjB,CADW,CACTQ,OAAO,CAACZ,QAAQ,GAAG,IAAI,CAAC,CAAC;IAC1B,MAAMa,MAAM,GAAG,UAAMd,yIAAK,EACxB,CAAA;;;gBAGJ,CAAiB,EACb;QAACY,MAAM;QAAEK,SAAS;QAAEZ,QAAQ;KAC9B,CAAC;IACD,OAAOS,MAAM,CAACC,IAAI,CAAC,CAAC,CAAC,IAAI,IAAI;AAC/B;AAEO,eAAeK,cAAcA,CAACR,MAAM,AAAQ,EAAN,AAAQK,SAAS,AAAQ,CAAC,CAAP,CAASJ,OAAO,CAAC,OAAO,CAAC,CAAC;IACxF,MAAMC,MAAM,GAAG,UAAMd,yIAAK,EACxB,CAAA,yEAAA,CAA2E,EAC3E;QAACY,MAAM;QAAEK,SAAS;KACpB,CAAC;IACD,OAAOH,MAAM,CAACO,QAAQ,GAAGP,MAAM,CAACO,QAAQ,GAAG,CAAC,GAAG,KAAK;AACtD;AAEO,eAAeC,SAASA,CAACV,MAAc,AAAR,CAAS,CAAP,CAASC,OAAO,CAAC,OAAO,CAAC,CAAC;IAChE,MAAMC,MAAM,GAAG,UAAMd,yIAAK,EAAC,CAAA,+CAAA,CAAiD,EAAE;QAACY,MAAM;KAAC,CAAC;IACvF,OAAOE,MAAM,CAACO,QAAQ,GAAGP,MAAM,CAACO,QAAQ,GAAG,CAAC,GAAG,KAAK;AACtD;AAEO,eAAeE,sBAAsBA,CAC1CX,MAAM,AAAQ,EAAN,AACRK,SAAS,AAAQ,CAClB,CADY,CACVJ,OAAO,CAACZ,QAAQ,GAAG,IAAI,CAAC,CAAC;IAC1B,MAAMa,MAAM,GAAG,UAAMd,yIAAK,EACxB,CAAA;;;;;;;;;6DASJ,CAA8D,EAC1D;QAACY,MAAM;QAAEK,SAAS;KACpB,CAAC;IACD,OAAOH,MAAM,CAACC,IAAI,CAAC,CAAC,CAAC,IAAI,IAAI;AAC/B","ignoreList":[],"debugId":null}},
    {"offset": {"line": 634, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/cloudflare.ts"],"sourcesContent":["/**\n * Cloudflare R2 utility functions\n * Handles image uploads to Cloudflare R2 (S3-compatible storage)\n */\n\nimport { S3Client, PutObjectCommand, DeleteObjectCommand, HeadObjectCommand } from '@aws-sdk/client-s3';\nimport { Upload } from '@aws-sdk/lib-storage';\n\ninterface CloudflareUploadResponse {\n  success: boolean;\n  result?: {\n    id: string;\n    filename: string;\n    uploaded: string;\n    url: string;\n    key: string;\n  };\n  errors?: Array<{\n    code: number;\n    message: string;\n  }>;\n}\n\n/**\n * Get S3 client configured for Cloudflare R2\n */\nfunction getR2Client(): S3Client {\n  const accessKeyId = process.env.CLOUDFLARE_R2_ACCESS_KEY_ID;\n  const secretAccessKey = process.env.CLOUDFLARE_R2_SECRET_ACCESS_KEY;\n  const endpoint = process.env.CLOUDFLARE_R2_ENDPOINT;\n  const accountId = process.env.CLOUDFLARE_ACCOUNT_ID;\n\n  if (!accessKeyId || !secretAccessKey) {\n    throw new Error('R2 credentials not configured. Please check CLOUDFLARE_R2_ACCESS_KEY_ID and CLOUDFLARE_R2_SECRET_ACCESS_KEY in .env.local');\n  }\n\n  // Use provided endpoint or construct from account ID\n  const r2Endpoint = endpoint || `https://${accountId}.r2.cloudflarestorage.com`;\n\n  return new S3Client({\n    region: 'auto',\n    endpoint: r2Endpoint,\n    credentials: {\n      accessKeyId,\n      secretAccessKey,\n    },\n  });\n}\n\n/**\n * Generate a unique key for the file in R2\n */\nfunction generateFileKey(filename: string): string {\n  const folder = process.env.CLOUDFLARE_PRODUCT_IMAGE_FOLDER || 'product_images';\n  const timestamp = Date.now();\n  const randomString = Math.random().toString(36).substring(2, 15);\n  const sanitizedFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_');\n\n  return `${folder}/${timestamp}-${randomString}-${sanitizedFilename}`;\n}\n\n/**\n * Upload an image to Cloudflare R2\n * @param imageFile - File or Buffer to upload\n * @param filename - Name of the file\n * @returns Upload response with file key and URL\n */\nexport async function uploadImageToCloudflare(\n  imageFile: File | Buffer,\n  filename: string\n): Promise<CloudflareUploadResponse> {\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  if (!bucket) {\n    throw new Error('R2 bucket not configured. Please check CLOUDFLARE_BUCKET in .env.local');\n  }\n\n  const client = getR2Client();\n  const key = generateFileKey(filename);\n\n  try {\n    let fileBuffer: Buffer;\n    let contentType = 'image/jpeg';\n\n    // Convert File to Buffer if needed\n    if (imageFile instanceof File) {\n      contentType = imageFile.type || 'image/jpeg';\n      const arrayBuffer = await imageFile.arrayBuffer();\n      fileBuffer = Buffer.from(arrayBuffer);\n    } else {\n      fileBuffer = imageFile;\n      // Try to detect content type from filename\n      if (filename.endsWith('.png')) contentType = 'image/png';\n      else if (filename.endsWith('.gif')) contentType = 'image/gif';\n      else if (filename.endsWith('.webp')) contentType = 'image/webp';\n      else if (filename.endsWith('.svg')) contentType = 'image/svg+xml';\n    }\n\n    // Upload to R2 using S3 SDK\n    const upload = new Upload({\n      client,\n      params: {\n        Bucket: bucket,\n        Key: key,\n        Body: fileBuffer,\n        ContentType: contentType,\n      },\n    });\n\n    await upload.done();\n\n    const url = getCloudflareImageUrl(key);\n\n    return {\n      success: true,\n      result: {\n        id: key, // Use R2 key as ID\n        filename,\n        uploaded: new Date().toISOString(),\n        url,\n        key,\n      },\n    };\n  } catch (error: any) {\n    console.error('Error uploading to R2:', error);\n    throw error;\n  }\n}\n\n/**\n * Delete an image from Cloudflare R2\n * @param imageKey - R2 object key (not image ID)\n * @returns Success status\n */\nexport async function deleteImageFromCloudflare(\n  imageKey: string\n): Promise<boolean> {\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  if (!bucket) {\n    throw new Error('R2 bucket not configured');\n  }\n\n  const client = getR2Client();\n\n  try {\n    const command = new DeleteObjectCommand({\n      Bucket: bucket,\n      Key: imageKey,\n    });\n\n    await client.send(command);\n    return true;\n  } catch (error) {\n    console.error('Error deleting from R2:', error);\n    return false;\n  }\n}\n\n/**\n * Get the public URL for an R2 object\n * @param imageKey - R2 object key\n * @returns Public URL for the image\n */\nexport function getCloudflareImageUrl(imageKey: string): string {\n  const publicUrl = process.env.CLOUDFLARE_R2_PUBLIC_URL;\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  // If public URL is configured, use it\n  if (publicUrl && publicUrl !== 'https://pub-your-id.r2.dev') {\n    return `${publicUrl}/${imageKey}`;\n  }\n\n  // Otherwise, return a placeholder (user needs to configure public access)\n  // In production, you should either:\n  // 1. Enable public access on the bucket and set CLOUDFLARE_R2_PUBLIC_URL\n  // 2. Use signed URLs\n  // 3. Use a custom domain\n  return `https://r2-placeholder.com/${bucket}/${imageKey}`;\n}\n\n/**\n * Check if an image exists in R2\n * @param imageKey - R2 object key\n * @returns True if exists, false otherwise\n */\nexport async function imageExists(imageKey: string): Promise<boolean> {\n  const bucket = process.env.CLOUDFLARE_BUCKET;\n\n  if (!bucket) {\n    return false;\n  }\n\n  const client = getR2Client();\n\n  try {\n    const command = new HeadObjectCommand({\n      Bucket: bucket,\n      Key: imageKey,\n    });\n\n    await client.send(command);\n    return true;\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * Upload multiple images to Cloudflare R2\n * @param images - Array of {file, filename} objects\n * @returns Array of upload results\n */\nexport async function uploadMultipleImages(\n  images: Array<{ file: File | Buffer; filename: string }>\n): Promise<Array<{ success: boolean; imageId?: string; filename: string; error?: string; url?: string }>> {\n  const results = await Promise.allSettled(\n    images.map(({ file, filename }) => uploadImageToCloudflare(file, filename))\n  );\n\n  return results.map((result, index) => {\n    if (result.status === 'fulfilled' && result.value.success) {\n      return {\n        success: true,\n        imageId: result.value.result?.id,\n        filename: images[index].filename,\n        url: result.value.result?.url,\n      };\n    } else {\n      return {\n        success: false,\n        filename: images[index].filename,\n        error: result.status === 'rejected' ? result.reason?.message : 'Upload failed',\n      };\n    }\n  });\n}\n"],"names":["S3Client","PutObjectCommand","DeleteObjectCommand","HeadObjectCommand","Upload","CloudflareUploadResponse","success","result","id","filename","uploaded","url","key","errors","Array","code","message","getR2Client","accessKeyId","process","env","CLOUDFLARE_R2_ACCESS_KEY_ID","secretAccessKey","CLOUDFLARE_R2_SECRET_ACCESS_KEY","endpoint","CLOUDFLARE_R2_ENDPOINT","accountId","CLOUDFLARE_ACCOUNT_ID","Error","r2Endpoint","region","credentials","generateFileKey","folder","CLOUDFLARE_PRODUCT_IMAGE_FOLDER","timestamp","Date","now","randomString","Math","random","toString","substring","sanitizedFilename","replace","uploadImageToCloudflare","imageFile","File","Buffer","Promise","bucket","CLOUDFLARE_BUCKET","client","fileBuffer","contentType","type","arrayBuffer","from","endsWith","upload","params","Bucket","Key","Body","ContentType","done","getCloudflareImageUrl","toISOString","error","console","deleteImageFromCloudflare","imageKey","command","send","publicUrl","CLOUDFLARE_R2_PUBLIC_URL","imageExists","uploadMultipleImages","images","file","imageId","results","allSettled","map","index","status","value","reason"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 809, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/cart/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getSessionFromCookie } from '@/lib/db/auth';\nimport {\n  getCartItems,\n  addCartItem,\n  updateCartItemQuantity,\n  removeCartItem,\n  clearCart,\n  getCartItemWithProduct,\n} from '@/lib/db/cart';\nimport { getCloudflareImageUrl } from '@/lib/cloudflare';\n\n// Verify user session and get user ID\nasync function getUserIdFromRequest(request: NextRequest) {\n  try {\n    const session = await getSessionFromCookie();\n    return session?.userId || null;\n  } catch (error) {\n    console.error('Error getting user session:', error);\n    return null;\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    console.log('üõí API /api/cart GET: Fetching cart items...');\n    const userId = await getUserIdFromRequest(request);\n    console.log('üõí API /api/cart GET: User ID from request:', userId);\n\n    if (userId) {\n      // Authenticated user - get database cart\n      console.log('üõí API /api/cart GET: Fetching cart items from database...');\n      const cartItems = await getCartItems(userId);\n      console.log('üõí API /api/cart GET: Found', cartItems.length, 'cart items');\n\n      // Format the response to match expected format\n      const formattedCartItems = cartItems.map((item: any) => {\n        // Use Cloudflare image URL if available, otherwise fall back to image_url\n        const imageUrl = item.primary_image_id\n          ? getCloudflareImageUrl(item.primary_image_id)\n          : item.image_url || null;\n\n        return {\n          id: item.id,\n          product_id: item.product_id,\n          quantity: item.quantity,\n          name: item.name || 'Unknown Product',\n          description: item.description || '',\n          price: item.price || 0,\n          image_url: imageUrl,\n          originalPrice: null, // Default values for compatibility\n          discount: 0,\n        };\n      });\n\n      console.log('üõí API /api/cart GET: ‚úÖ Returning', formattedCartItems.length, 'formatted items');\n      return NextResponse.json(\n        { success: true, data: formattedCartItems },\n        { status: 200 }\n      );\n    } else {\n      // Unauthenticated user - return empty cart\n      console.log('üõí API /api/cart GET: No user ID, returning empty cart');\n      return NextResponse.json({ success: true, data: [] }, { status: 200 });\n    }\n  } catch (error: any) {\n    console.error('‚ùå API /api/cart GET: Error fetching cart:', error);\n    console.error('‚ùå API /api/cart GET: Error message:', error?.message);\n    console.error('‚ùå API /api/cart GET: Error stack:', error?.stack);\n    return NextResponse.json(\n      { success: false, error: error?.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const userId = await getUserIdFromRequest(request);\n\n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const { product_id, quantity = 1 } = await request.json();\n\n    if (!product_id) {\n      return NextResponse.json(\n        { success: false, error: 'Valid product ID is required' },\n        { status: 400 }\n      );\n    }\n\n    if (typeof quantity !== 'number' || isNaN(quantity) || quantity <= 0) {\n      return NextResponse.json(\n        { success: false, error: 'Valid positive quantity is required' },\n        { status: 400 }\n      );\n    }\n\n    // Add item to cart (will update if exists)\n    await addCartItem(userId, product_id, quantity);\n\n    // Get the updated cart item with product details\n    const cartItem = await getCartItemWithProduct(userId, product_id);\n\n    if (!cartItem) {\n      return NextResponse.json(\n        { success: false, error: 'Failed to add item to cart' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json(\n      {\n        success: true,\n        data: {\n          id: cartItem.id,\n          product_id: cartItem.product_id,\n          name: cartItem.name || 'Unknown Product',\n          price: cartItem.price || 0,\n          quantity: cartItem.quantity,\n          image_url: cartItem.image_url || null,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error: any) {\n    console.error('Error adding to cart:', error);\n    return NextResponse.json(\n      { success: false, error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  try {\n    const userId = await getUserIdFromRequest(request);\n\n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const { product_id, quantity } = await request.json();\n\n    if (!product_id) {\n      return NextResponse.json(\n        { success: false, error: 'Valid product ID is required' },\n        { status: 400 }\n      );\n    }\n\n    if (typeof quantity !== 'number' || isNaN(quantity)) {\n      return NextResponse.json(\n        { success: false, error: 'Valid quantity is required' },\n        { status: 400 }\n      );\n    }\n\n    if (quantity <= 0) {\n      // If quantity is 0 or negative, remove item from cart\n      await removeCartItem(userId, product_id);\n\n      return NextResponse.json(\n        { success: true, message: 'Item removed from cart' },\n        { status: 200 }\n      );\n    } else {\n      // Update quantity\n      await updateCartItemQuantity(userId, product_id, quantity);\n\n      // Get the updated cart item with product details\n      const cartItem = await getCartItemWithProduct(userId, product_id);\n\n      if (!cartItem) {\n        return NextResponse.json(\n          { success: false, error: 'Failed to update cart item' },\n          { status: 500 }\n        );\n      }\n\n      return NextResponse.json(\n        {\n          success: true,\n          data: {\n            id: cartItem.id,\n            product_id: cartItem.product_id,\n            name: cartItem.name || 'Unknown Product',\n            price: cartItem.price || 0,\n            quantity: cartItem.quantity,\n            image_url: cartItem.image_url || null,\n          },\n        },\n        { status: 200 }\n      );\n    }\n  } catch (error: any) {\n    console.error('Error updating cart:', error);\n    return NextResponse.json(\n      { success: false, error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(request: NextRequest) {\n  try {\n    const userId = await getUserIdFromRequest(request);\n\n    if (userId) {\n      // Authenticated user - clear database cart\n      await clearCart(userId);\n\n      return NextResponse.json(\n        { success: true, message: 'Cart cleared' },\n        { status: 200 }\n      );\n    } else {\n      // Unauthenticated user - return success for client-side cart handling\n      return NextResponse.json(\n        { success: true, message: 'Cart cleared' },\n        { status: 200 }\n      );\n    }\n  } catch (error: any) {\n    console.error('Error clearing cart:', error);\n    return NextResponse.json(\n      { success: false, error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}"],"names":["NextRequest","NextResponse","getSessionFromCookie","getCartItems","addCartItem","updateCartItemQuantity","removeCartItem","clearCart","getCartItemWithProduct","getCloudflareImageUrl","getUserIdFromRequest","request","session","userId","error","console","GET","log","cartItems","length","formattedCartItems","map","item","imageUrl","primary_image_id","image_url","id","product_id","quantity","name","description","price","originalPrice","discount","json","success","data","status","message","stack","POST","isNaN","cartItem","PUT","DELETE"],"mappings":"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","ignoreList":[],"debugId":null}}]
}