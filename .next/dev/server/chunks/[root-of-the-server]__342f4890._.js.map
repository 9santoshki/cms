{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/connection.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  host: process.env.DB_HOST || 'localhost',\n  port: parseInt(process.env.DB_PORT || '5432'),\n  database: process.env.DB_NAME || 'cmsdb',\n  user: process.env.DB_USER || 'sk',\n  password: process.env.DB_PASSWORD || 'sk',\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n  process.exit(-1);\n});\n\nexport const query = async (text: string, params?: any[]) => {\n  try {\n    const res = await pool.query(text, params);\n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n};\n\nexport const getClient = async (): Promise<PoolClient> => {\n  const client = await pool.connect();\n  return client;\n};\n\nexport default pool;\n"],"names":["Pool","PoolClient","pool","host","process","env","DB_HOST","port","parseInt","DB_PORT","database","DB_NAME","user","DB_USER","password","DB_PASSWORD","max","idleTimeoutMillis","connectionTimeoutMillis","on","err","console","error","exit","query","text","params","res","getClient","Promise","client","connect"],"mappings":";;;;;;;;AAAA,SAASA,IAAI,EAAEC,UAAU,QAAQ,IAAI;;;;;;AAErC,2BAAA;AACA,MAAMC,IAAI,GAAG,IAAIF,4GAAI,CAAC;IACpBG,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,OAAO,IAAI,WAAW;IACxCC,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAG,CAACI,OAAO,IAAI,MAAM,CAAC;IAC7CC,QAAQ,EAAEN,OAAO,CAACC,GAAG,CAACM,OAAO,IAAI,OAAO;IACxCC,IAAI,EAAER,OAAO,CAACC,GAAG,CAACQ,OAAO,IAAI,IAAI;IACjCC,QAAQ,EAAEV,OAAO,CAACC,GAAG,CAACU,WAAW,IAAI,IAAI;IACzCC,GAAG,EAAE,EAAE;IACPC,iBAAiB,EAAE,KAAK;IACxBC,uBAAuB,EAAE;AAC3B,CAAC,CAAC;AAEFhB,IAAI,CAACiB,EAAE,CAAC,OAAO,GAAGC,GAAG,IAAK;IACxBC,OAAO,CAACC,KAAK,CAAC,iCAAiC,EAAEF,GAAG,CAAC;IACrDhB,OAAO,CAACmB,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEK,MAAMC,KAAK,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,AAAgB,CAAP,EAAE,GAAG,EAAE,KAAK;IAC3D,IAAI;QACF,MAAMC,GAAG,GAAG,MAAMzB,IAAI,CAACsB,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;QAC1C,OAAOC,GAAG;IACZ,CAAC,CAAC,OAAOL,KAAK,EAAE;QACdD,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC7C,MAAMA,KAAK;IACb;AACF,CAAC;AAEM,MAAMM,SAAS,GAAG,MAAAA,CAAA,CAAQ,EAAEC,OAAO,CAAC5B,UAAU,CAAC,IAAI;IACxD,MAAM6B,MAAM,GAAG,MAAM5B,IAAI,CAAC6B,OAAO,CAAC,CAAC;IACnC,OAAOD,MAAM;AACf,CAAC;uCAEc5B,IAAI","ignoreList":[],"debugId":null}},
    {"offset": {"line": 132, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/auth.ts"],"sourcesContent":["import { query } from './connection';\nimport { cookies, headers } from 'next/headers';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\nconst SESSION_COOKIE_NAME = 'cms-session';\nconst SESSION_DURATION_DAYS = 30; // 30 days for persistent login\n\nexport interface UserProfile {\n  id: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: 'customer' | 'moderator' | 'admin';\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface SessionData {\n  userId: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: string;\n  sessionId?: string; // Database session ID\n}\n\nexport interface DBSession {\n  id: string;\n  user_id: string;\n  session_token: string;\n  refresh_token?: string;\n  user_agent?: string;\n  ip_address?: string;\n  expires_at: string;\n  created_at: string;\n  updated_at: string;\n  last_activity: string;\n}\n\n// Create or update user from Google OAuth\nexport const upsertUserFromGoogle = async (googleUser: {\n  id: string;\n  email: string;\n  name: string;\n  picture?: string;\n}): Promise<UserProfile> => {\n  // Check if user exists\n  const existingUser = await query(\n    'SELECT * FROM users WHERE email = $1',\n    [googleUser.email]\n  );\n\n  let userId: string;\n\n  if (existingUser.rows.length > 0) {\n    // Update existing user\n    userId = existingUser.rows[0].id;\n    await query(\n      `UPDATE users\n       SET name = $1, avatar = $2, google_id = $3, updated_at = NOW()\n       WHERE id = $4`,\n      [googleUser.name, googleUser.picture, googleUser.id, userId]\n    );\n  } else {\n    // Create new user\n    const newUser = await query(\n      `INSERT INTO users (email, name, avatar, google_id, role)\n       VALUES ($1, $2, $3, $4, 'customer')\n       RETURNING id`,\n      [googleUser.email, googleUser.name, googleUser.picture, googleUser.id]\n    );\n    userId = newUser.rows[0].id;\n  }\n\n  // Get the complete user profile\n  const userProfile = await getUserProfile(userId);\n  if (!userProfile) {\n    throw new Error('Failed to create or fetch user profile');\n  }\n\n  return userProfile;\n};\n\n// Get user profile by ID\nexport const getUserProfile = async (userId: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE id = $1',\n    [userId]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Get user profile by email\nexport const getUserByEmail = async (email: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE email = $1',\n    [email]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Create session token\nexport const createSessionToken = (user: UserProfile): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: '7d' });\n};\n\n// Verify session token\nexport const verifySessionToken = (token: string): SessionData | null => {\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as SessionData;\n    return decoded;\n  } catch (error) {\n    console.error('Invalid token:', error);\n    return null;\n  }\n};\n\n// Set session cookie\nexport const setSessionCookie = async (token: string) => {\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7, // 7 days\n    path: '/',\n  });\n};\n\n// Get session from cookie\nexport const getSessionFromCookie = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  return verifySessionToken(sessionCookie.value);\n};\n\n// Clear session cookie\nexport const clearSessionCookie = async () => {\n  const cookieStore = await cookies();\n  cookieStore.delete(SESSION_COOKIE_NAME);\n};\n\n// Update user role (admin only)\nexport const updateUserRole = async (\n  userId: string,\n  newRole: 'customer' | 'moderator' | 'admin'\n): Promise<void> => {\n  await query(\n    'UPDATE users SET role = $1, updated_at = NOW() WHERE id = $2',\n    [newRole, userId]\n  );\n};\n\n// Get all user profiles (admin only)\nexport const getAllUserProfiles = async (): Promise<UserProfile[]> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users ORDER BY created_at DESC'\n  );\n\n  return result.rows;\n};\n\n// Update user profile\nexport const updateUserProfile = async (\n  userId: string,\n  updates: { name?: string; avatar?: string }\n): Promise<UserProfile | null> => {\n  const fields: string[] = [];\n  const values: any[] = [];\n  let paramCount = 1;\n\n  if (updates.name !== undefined) {\n    fields.push(`name = $${paramCount++}`);\n    values.push(updates.name);\n  }\n\n  if (updates.avatar !== undefined) {\n    fields.push(`avatar = $${paramCount++}`);\n    values.push(updates.avatar);\n  }\n\n  if (fields.length === 0) {\n    return getUserProfile(userId);\n  }\n\n  fields.push(`updated_at = NOW()`);\n  values.push(userId);\n\n  await query(\n    `UPDATE users SET ${fields.join(', ')} WHERE id = $${paramCount}`,\n    values\n  );\n\n  return getUserProfile(userId);\n};\n\n// ============================================================================\n// SESSION MANAGEMENT (Database-backed persistent sessions)\n// ============================================================================\n\n// Generate secure random token\nconst generateSecureToken = (): string => {\n  return crypto.randomBytes(32).toString('hex');\n};\n\n// Get request metadata (user agent, IP)\nconst getRequestMetadata = async () => {\n  try {\n    const headersList = await headers();\n    const userAgent = (await headersList).get('user-agent') || undefined;\n    const forwardedFor = (await headersList).get('x-forwarded-for');\n    const realIp = (await headersList).get('x-real-ip');\n    const ipAddress = forwardedFor?.split(',')[0] || realIp || undefined;\n\n    return { userAgent, ipAddress };\n  } catch (error) {\n    return { userAgent: undefined, ipAddress: undefined };\n  }\n};\n\n// Create a new session in the database\nexport const createSession = async (\n  user: UserProfile,\n  rememberMe: boolean = true\n): Promise<{ sessionToken: string; refreshToken: string; dbSession: DBSession }> => {\n  const sessionToken = generateSecureToken();\n  const refreshToken = generateSecureToken();\n  const { userAgent, ipAddress } = await getRequestMetadata();\n\n  // Calculate expiration based on remember me option\n  const durationDays = rememberMe ? SESSION_DURATION_DAYS : 1; // 30 days or 1 day\n  const expiresAt = new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000);\n\n  const result = await query(\n    `INSERT INTO sessions (user_id, session_token, refresh_token, user_agent, ip_address, expires_at)\n     VALUES ($1, $2, $3, $4, $5, $6)\n     RETURNING *`,\n    [user.id, sessionToken, refreshToken, userAgent, ipAddress, expiresAt]\n  );\n\n  return {\n    sessionToken,\n    refreshToken,\n    dbSession: result.rows[0]\n  };\n};\n\n// Get session from database by token\nexport const getSessionFromDB = async (sessionToken: string): Promise<DBSession | null> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE session_token = $1\n     AND expires_at > NOW()`,\n    [sessionToken]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Update session activity timestamp\nexport const updateSessionActivity = async (sessionId: string): Promise<void> => {\n  await query(\n    'UPDATE sessions SET last_activity = NOW() WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Delete a specific session\nexport const deleteSession = async (sessionToken: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE session_token = $1',\n    [sessionToken]\n  );\n};\n\n// Delete all sessions for a user\nexport const deleteUserSessions = async (userId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE user_id = $1',\n    [userId]\n  );\n};\n\n// Delete a specific session by ID\nexport const deleteSessionById = async (sessionId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Clean up expired sessions\nexport const cleanupExpiredSessions = async (): Promise<number> => {\n  const result = await query('SELECT cleanup_expired_sessions()');\n  return result.rows[0].cleanup_expired_sessions;\n};\n\n// Get all active sessions for a user\nexport const getUserSessions = async (userId: string): Promise<DBSession[]> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE user_id = $1\n     AND expires_at > NOW()\n     ORDER BY last_activity DESC`,\n    [userId]\n  );\n\n  return result.rows;\n};\n\n// Enhanced session token creation with database session ID\nexport const createSessionTokenWithDB = (user: UserProfile, sessionId: string): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n    sessionId: sessionId, // Include DB session ID in JWT\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: `${SESSION_DURATION_DAYS}d` });\n};\n\n// Enhanced session validation (checks both JWT and database)\nexport const validateSession = async (token: string): Promise<SessionData | null> => {\n  // First verify JWT\n  const jwtData = verifySessionToken(token);\n  if (!jwtData) {\n    return null;\n  }\n\n  // If JWT has session ID, verify against database\n  if (jwtData.sessionId) {\n    const dbSession = await query(\n      'SELECT * FROM sessions WHERE id = $1 AND expires_at > NOW()',\n      [jwtData.sessionId]\n    );\n\n    if (dbSession.rows.length === 0) {\n      // Session was invalidated in database\n      return null;\n    }\n\n    // Update last activity\n    await updateSessionActivity(jwtData.sessionId);\n  }\n\n  return jwtData;\n};\n\n// Enhanced get session from cookie with database validation\nexport const getSessionFromCookieWithDB = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  // Validate against database as well\n  return validateSession(sessionCookie.value);\n};\n\n// Enhanced set session cookie with longer duration\nexport const setSessionCookieWithDB = async (token: string, rememberMe: boolean = true) => {\n  const cookieStore = await cookies();\n  const maxAge = rememberMe\n    ? 60 * 60 * 24 * SESSION_DURATION_DAYS  // 30 days\n    : 60 * 60 * 24; // 1 day\n\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: maxAge,\n    path: '/',\n  });\n};\n\n// Enhanced logout that clears both cookie and database session\nexport const logoutSession = async (): Promise<void> => {\n  const session = await getSessionFromCookieWithDB();\n\n  // Clear cookie\n  await clearSessionCookie();\n\n  // Delete from database if session ID exists\n  if (session?.sessionId) {\n    await deleteSessionById(session.sessionId);\n  }\n};\n"],"names":["query","cookies","headers","jwt","crypto","JWT_SECRET","process","env","SESSION_COOKIE_NAME","SESSION_DURATION_DAYS","UserProfile","id","email","name","avatar","role","created_at","updated_at","SessionData","userId","sessionId","DBSession","user_id","session_token","refresh_token","user_agent","ip_address","expires_at","last_activity","upsertUserFromGoogle","googleUser","picture","Promise","existingUser","rows","length","newUser","userProfile","getUserProfile","Error","result","getUserByEmail","createSessionToken","user","sessionData","sign","expiresIn","verifySessionToken","token","decoded","verify","error","console","setSessionCookie","cookieStore","set","httpOnly","secure","NODE_ENV","sameSite","maxAge","path","getSessionFromCookie","sessionCookie","get","value","clearSessionCookie","delete","updateUserRole","newRole","getAllUserProfiles","updateUserProfile","updates","fields","values","paramCount","undefined","push","join","generateSecureToken","randomBytes","toString","getRequestMetadata","headersList","userAgent","forwardedFor","realIp","ipAddress","split","createSession","rememberMe","sessionToken","refreshToken","dbSession","durationDays","expiresAt","Date","now","getSessionFromDB","updateSessionActivity","deleteSession","deleteUserSessions","deleteSessionById","cleanupExpiredSessions","cleanup_expired_sessions","getUserSessions","createSessionTokenWithDB","validateSession","jwtData","getSessionFromCookieWithDB","setSessionCookieWithDB","logoutSession","session"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 488, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/reviews.ts"],"sourcesContent":["import { query } from './connection';\n\nexport interface Review {\n  id: string;\n  user_id: string;\n  product_id: string;\n  rating: number;\n  comment: string;\n  status: 'pending' | 'approved' | 'rejected';\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface ReviewWithDetails extends Review {\n  user_name: string;\n  user_email: string;\n  user_avatar?: string;\n  product_name: string;\n}\n\nexport interface ProductRating {\n  average_rating: number;\n  review_count: number;\n}\n\n/**\n * Get all reviews with optional filters (for admin/moderator)\n */\nexport async function getReviews(filters: {\n  status?: string;\n  product_id?: string;\n  user_id?: string;\n  page?: number;\n  limit?: number;\n}): Promise<{ reviews: ReviewWithDetails[]; total: number }> {\n  const page = filters.page || 1;\n  const limit = filters.limit || 20;\n  const offset = (page - 1) * limit;\n\n  let whereConditions: string[] = [];\n  let params: any[] = [];\n  let paramCount = 1;\n\n  if (filters.status) {\n    whereConditions.push(`r.status = $${paramCount}`);\n    params.push(filters.status);\n    paramCount++;\n  }\n\n  if (filters.product_id) {\n    whereConditions.push(`r.product_id = $${paramCount}`);\n    params.push(filters.product_id);\n    paramCount++;\n  }\n\n  if (filters.user_id) {\n    whereConditions.push(`r.user_id = $${paramCount}`);\n    params.push(filters.user_id);\n    paramCount++;\n  }\n\n  const whereClause = whereConditions.length > 0 ? 'WHERE ' + whereConditions.join(' AND ') : '';\n\n  const reviewsQuery = `\n    SELECT\n      r.*,\n      u.name as user_name,\n      u.email as user_email,\n      u.avatar as user_avatar,\n      p.name as product_name\n    FROM reviews r\n    JOIN users u ON r.user_id = u.id\n    JOIN products p ON r.product_id = p.id\n    ${whereClause}\n    ORDER BY r.created_at DESC\n    LIMIT $${paramCount} OFFSET $${paramCount + 1}\n  `;\n  params.push(limit, offset);\n\n  const result = await query(reviewsQuery, params);\n\n  // Get total count\n  const countQuery = `SELECT COUNT(*) as count FROM reviews r ${whereClause}`;\n  const countResult = await query(countQuery, params.slice(0, paramCount - 1));\n  const total = parseInt(countResult.rows[0].count);\n\n  return {\n    reviews: result.rows,\n    total,\n  };\n}\n\n/**\n * Get approved reviews for a product (public facing)\n */\nexport async function getProductReviews(productId: string): Promise<ReviewWithDetails[]> {\n  const result = await query(\n    `SELECT\n      r.*,\n      u.name as user_name,\n      u.email as user_email,\n      u.avatar as user_avatar,\n      p.name as product_name\n    FROM reviews r\n    JOIN users u ON r.user_id = u.id\n    JOIN products p ON r.product_id = p.id\n    WHERE r.product_id = $1 AND r.status = 'approved'\n    ORDER BY r.created_at DESC`,\n    [productId]\n  );\n  return result.rows;\n}\n\n/**\n * Get average rating and review count for a product\n */\nexport async function getProductRating(productId: string): Promise<ProductRating> {\n  const result = await query(\n    `SELECT\n      COALESCE(AVG(rating), 0) as average_rating,\n      COUNT(*) as review_count\n    FROM reviews\n    WHERE product_id = $1 AND status = 'approved'`,\n    [productId]\n  );\n  return {\n    average_rating: parseFloat(result.rows[0].average_rating) || 0,\n    review_count: parseInt(result.rows[0].review_count) || 0,\n  };\n}\n\n/**\n * Get a single review by ID\n */\nexport async function getReviewById(id: string): Promise<ReviewWithDetails | null> {\n  const result = await query(\n    `SELECT\n      r.*,\n      u.name as user_name,\n      u.email as user_email,\n      u.avatar as user_avatar,\n      p.name as product_name\n    FROM reviews r\n    JOIN users u ON r.user_id = u.id\n    JOIN products p ON r.product_id = p.id\n    WHERE r.id = $1`,\n    [id]\n  );\n  return result.rows[0] || null;\n}\n\n/**\n * Check if user has already reviewed a product\n */\nexport async function hasUserReviewedProduct(userId: string, productId: string): Promise<boolean> {\n  const result = await query(\n    'SELECT id FROM reviews WHERE user_id = $1 AND product_id = $2',\n    [userId, productId]\n  );\n  return result.rows.length > 0;\n}\n\n/**\n * Create a new review\n */\nexport async function createReview(review: {\n  user_id: string;\n  product_id: string;\n  rating: number;\n  comment: string;\n}): Promise<Review> {\n  const result = await query(\n    `INSERT INTO reviews (user_id, product_id, rating, comment, status)\n     VALUES ($1, $2, $3, $4, 'pending')\n     RETURNING *`,\n    [review.user_id, review.product_id, review.rating, review.comment]\n  );\n  return result.rows[0];\n}\n\n/**\n * Update review status (for moderation)\n */\nexport async function updateReviewStatus(\n  id: string,\n  status: 'pending' | 'approved' | 'rejected'\n): Promise<Review | null> {\n  const result = await query(\n    `UPDATE reviews SET status = $1, updated_at = NOW() WHERE id = $2 RETURNING *`,\n    [status, id]\n  );\n  return result.rows[0] || null;\n}\n\n/**\n * Delete a review\n */\nexport async function deleteReview(id: string): Promise<boolean> {\n  const result = await query('DELETE FROM reviews WHERE id = $1', [id]);\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n"],"names":["query","Review","id","user_id","product_id","rating","comment","status","created_at","updated_at","ReviewWithDetails","user_name","user_email","user_avatar","product_name","ProductRating","average_rating","review_count","getReviews","filters","page","limit","Promise","reviews","total","offset","whereConditions","params","paramCount","push","whereClause","length","join","reviewsQuery","result","countQuery","countResult","slice","parseInt","rows","count","getProductReviews","productId","getProductRating","parseFloat","getReviewById","hasUserReviewedProduct","userId","createReview","review","updateReviewStatus","deleteReview","rowCount"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 642, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/reviews/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getSessionFromCookie, getUserProfile } from '@/lib/db/auth';\nimport {\n  getReviews,\n  getProductReviews,\n  getProductRating,\n  createReview,\n  hasUserReviewedProduct,\n} from '@/lib/db/reviews';\n\n// Verify user session and get user info\nasync function getUserFromRequest() {\n  try {\n    const session = await getSessionFromCookie();\n    if (!session?.userId) return null;\n\n    const profile = await getUserProfile(session.userId);\n    return profile ? { userId: session.userId, role: profile.role, name: profile.name } : null;\n  } catch (error) {\n    console.error('Error getting user session:', error);\n    return null;\n  }\n}\n\nconst corsHeaders = {\n  'Access-Control-Allow-Credentials': 'true',\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET,DELETE,PATCH,POST,PUT,OPTIONS',\n  'Access-Control-Allow-Headers':\n    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization',\n};\n\nexport async function OPTIONS() {\n  return NextResponse.json({}, { headers: corsHeaders });\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const productId = searchParams.get('product_id');\n    const status = searchParams.get('status');\n    const includeRating = searchParams.get('include_rating') === 'true';\n\n    // If product_id is provided, return public reviews for that product\n    if (productId) {\n      const reviews = await getProductReviews(productId);\n\n      if (includeRating) {\n        const rating = await getProductRating(productId);\n        return NextResponse.json(\n          {\n            success: true,\n            data: {\n              reviews,\n              rating: rating.average_rating,\n              reviewCount: rating.review_count,\n            },\n          },\n          { headers: corsHeaders }\n        );\n      }\n\n      return NextResponse.json(\n        { success: true, data: reviews },\n        { headers: corsHeaders }\n      );\n    }\n\n    // For listing all reviews (admin/moderator only)\n    const user = await getUserFromRequest();\n    if (!user || (user.role !== 'admin' && user.role !== 'moderator')) {\n      return NextResponse.json(\n        { success: false, error: 'Admin or moderator access required' },\n        { status: 403, headers: corsHeaders }\n      );\n    }\n\n    const page = parseInt(searchParams.get('page') || '1');\n    const limit = parseInt(searchParams.get('limit') || '20');\n\n    const result = await getReviews({\n      status: status || undefined,\n      page,\n      limit,\n    });\n\n    return NextResponse.json(\n      {\n        success: true,\n        data: result.reviews,\n        total: result.total,\n        page,\n        limit,\n      },\n      { headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error fetching reviews:', error);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const user = await getUserFromRequest();\n\n    if (!user) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required to submit a review' },\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    const { product_id, rating, comment } = await request.json();\n\n    // Validate required fields\n    if (!product_id || !rating || !comment) {\n      return NextResponse.json(\n        { success: false, error: 'Product ID, rating, and comment are required' },\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    // Validate rating range\n    if (rating < 1 || rating > 5) {\n      return NextResponse.json(\n        { success: false, error: 'Rating must be between 1 and 5' },\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    // Check if user has already reviewed this product\n    const hasReviewed = await hasUserReviewedProduct(user.userId, product_id);\n    if (hasReviewed) {\n      return NextResponse.json(\n        { success: false, error: 'You have already reviewed this product' },\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    const review = await createReview({\n      user_id: user.userId,\n      product_id,\n      rating,\n      comment,\n    });\n\n    console.log(`New review submitted by user ${user.userId} for product ${product_id} (pending approval)`);\n\n    return NextResponse.json(\n      {\n        success: true,\n        data: review,\n        message: 'Review submitted successfully. It will be visible after moderation.',\n      },\n      { status: 201, headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error creating review:', error);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n"],"names":["NextRequest","NextResponse","getSessionFromCookie","getUserProfile","getReviews","getProductReviews","getProductRating","createReview","hasUserReviewedProduct","getUserFromRequest","session","userId","profile","role","name","error","console","corsHeaders","OPTIONS","json","headers","GET","request","searchParams","URL","url","productId","get","status","includeRating","reviews","rating","success","data","average_rating","reviewCount","review_count","user","page","parseInt","limit","result","undefined","total","POST","product_id","comment","hasReviewed","review","user_id","log","message"],"mappings":"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","ignoreList":[],"debugId":null}}]
}