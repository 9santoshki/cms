{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/supabaseConnection.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\n// In a Next.js app, environment variables are available via process.env\n// For direct Node.js execution, we load .env manually\nif (typeof window === 'undefined') { // Server-side\n  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {\n    // Try to load from .env file for server-side testing\n    if (typeof require !== 'undefined') {\n      require('dotenv').config({ path: './.env.local' });\n    }\n  }\n}\n\n// Supabase client configuration\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  console.error('Error: Supabase URL and Anon Key are required for Supabase connection');\n  console.log('Please make sure .env.local file contains:');\n  console.log('NEXT_PUBLIC_SUPABASE_URL=');\n  console.log('NEXT_PUBLIC_SUPABASE_ANON_KEY=');\n  // Depending on your setup, you might want to throw an error in production\n  // throw new Error('Supabase URL and Anon Key are required for Supabase connection');\n}\n\nexport const supabase = supabaseUrl && supabaseAnonKey ? \n  createClient(supabaseUrl, supabaseAnonKey) : \n  null;\n\n// Define types to maintain compatibility\ntype QueryResult = {\n  data?: any;\n  error?: any;\n  rows?: any[];\n  rowCount?: number;\n};\n\n// Helper function to handle Supabase results and transform to pg-like format\nexport function formatResult(result: { data?: any; error?: any }) {\n  if (result.error) {\n    return {\n      rows: [],\n      rowCount: 0,\n      error: result.error\n    };\n  }\n\n  const rows = Array.isArray(result.data) ? result.data : (result.data ? [result.data] : []);\n  return {\n    rows: rows,\n    rowCount: rows.length,\n    error: null\n  };\n}\n\n// Function to extract table name from SQL\nfunction getTableNameFromSQL(sql: string): string | null {\n  const selectMatch = sql.match(/select\\s+(.*?)\\s+from\\s+([a-zA-Z_][a-zA-Z0-9_]*)/i);\n  const insertMatch = sql.match(/insert\\s+into\\s+([a-zA-Z_][a-zA-Z0-9_]*)/i);\n  const updateMatch = sql.match(/update\\s+([a-zA-Z_][a-zA-Z0-9_]*)/i);\n  const deleteMatch = sql.match(/delete\\s+from\\s+([a-zA-Z_][a-zA-Z0-9_]*)/i);\n\n  if (selectMatch) return selectMatch[2];\n  if (insertMatch) return insertMatch[1];\n  if (updateMatch) return updateMatch[1];\n  if (deleteMatch) return deleteMatch[1];\n\n  return null;\n}\n\n// Function to extract columns from SELECT statement\nfunction getColumnsFromSelect(sql: string): string {\n  const selectMatch = sql.match(/select\\s+(.*?)\\s+from/i);\n  return selectMatch ? selectMatch[1].trim() : '*';\n}\n\n// Helper function to handle SELECT queries\nexport async function handleSelectQuery(sql: string, params?: any[]): Promise<any> {\n  if (!supabase) {\n    return { data: [], error: 'Supabase client not initialized' };\n  }\n\n  const tableName = getTableNameFromSQL(sql);\n  const columns = getColumnsFromSelect(sql);\n  \n  if (!tableName) {\n    return { data: [], error: 'Could not parse table name from SQL' };\n  }\n\n  try {\n    // Handle specific tables with special configurations\n    if (tableName === 'shipping_config' || tableName === 'tax_config') {\n      try {\n        // Attempt to get configuration\n        const result = await supabase\n          .from(tableName)\n          .select(columns === '*' ? '*' : columns)\n          .order('created_at', { ascending: false })\n          .limit(1);\n\n        if (result.error) {\n          // If the table doesn't exist, return default configuration\n          if (result.error.code === '42P01' || result.error.message?.includes('does not exist')) {\n            if (tableName === 'shipping_config') {\n              return { \n                data: [{\n                  id: 1,\n                  min_order_amount: 50000,\n                  flat_rate: 1500,\n                  enabled: true,\n                  created_at: new Date().toISOString()\n                }], \n                error: null \n              };\n            } else if (tableName === 'tax_config') {\n              return { \n                data: [{\n                  id: 1,\n                  rate: 0,\n                  type: 'percentage',\n                  enabled: false,\n                  created_at: new Date().toISOString()\n                }], \n                error: null \n              };\n            }\n          }\n          // Return empty array if table doesn't exist but don't throw error\n          return { data: [], error: null };\n        }\n        \n        return result;\n      } catch (configError) {\n        console.error(`Configuration table ${tableName} error:`, configError);\n        // Return default configuration\n        if (tableName === 'shipping_config') {\n          return { \n            data: [{\n              id: 1,\n              min_order_amount: 50000,\n              flat_rate: 1500,\n              enabled: true,\n              created_at: new Date().toISOString()\n            }], \n            error: null \n          };\n        } else if (tableName === 'tax_config') {\n          return { \n            data: [{\n              id: 1,\n              rate: 0,\n              type: 'percentage',\n              enabled: false,\n              created_at: new Date().toISOString()\n            }], \n            error: null \n          };\n        }\n      }\n    }\n\n    // Handle regular table queries\n    const hasWhere = sql.toLowerCase().includes('where');\n    let queryBuilder = supabase.from(tableName).select(columns === '*' ? '*' : columns);\n\n    if (hasWhere) {\n      // Extract WHERE clause - this is a simplified approach\n      const whereRegex = /where\\s+(.*?)(?:\\s+order\\s+by|\\s+limit|\\s+group\\s+by|$)/i;\n      const whereMatch = sql.match(whereRegex);\n\n      if (whereMatch && whereMatch[1]) {\n        const whereClause = whereMatch[1].trim();\n\n        // Handle different WHERE patterns with parameters\n        if (whereClause.includes('email = $1 OR google_id = $2') && params && params.length >= 2) {\n          queryBuilder = queryBuilder.or(`email.eq.${params[0]},google_id.eq.${params[1]}`);\n        } else if (whereClause.includes('email = $1') && params && params.length >= 1) {\n          queryBuilder = queryBuilder.eq('email', params[0]);\n        } else if (whereClause.includes('product_id = $1') && params && params.length >= 1) {\n          queryBuilder = queryBuilder.eq('product_id', params[0]);\n        } else if (whereClause.includes('user_id = $1') && params && params.length >= 1) {\n          queryBuilder = queryBuilder.eq('user_id', params[0]);\n        } else if (whereClause.includes('user_id = $1 AND product_id = $2') && params && params.length >= 2) {\n          queryBuilder = queryBuilder.eq('user_id', params[0]).eq('product_id', params[1]);\n        } else if (whereClause.includes('id = $1') && params && params.length >= 1) {\n          queryBuilder = queryBuilder.eq('id', params[0]);\n        } else if (whereClause.includes('slug = $1') && params && params.length >= 1) {\n          queryBuilder = queryBuilder.eq('slug', params[0]);\n        } else if (whereClause.includes('CAST(google_id AS TEXT) = $1') && params && params.length >= 1) {\n          queryBuilder = queryBuilder.eq('google_id', params[0]);\n        } else {\n          // Basic single condition handling\n          const conditionRegex = /([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*\\$(\\d+)/;\n          const conditionMatch = whereClause.match(conditionRegex);\n          if (conditionMatch && params && params.length >= parseInt(conditionMatch[2])) {\n            const columnName = conditionMatch[1];\n            const paramIndex = parseInt(conditionMatch[2]) - 1;\n            queryBuilder = queryBuilder.eq(columnName, params[paramIndex]);\n          }\n        }\n      }\n    }\n\n    const result = await queryBuilder;\n    return result;\n  } catch (error: any) {\n    console.error(`Error executing SELECT query on table ${tableName}:`, error);\n    // For table not found or other errors, return empty result instead of throwing\n    return { data: [], error: null };\n  }\n}\n\n// Helper function for INSERT operations\nexport async function handleInsertQuery(sql: string, params?: any[]): Promise<any> {\n  if (!supabase) {\n    return { data: null, error: 'Supabase client not initialized' };\n  }\n\n  const tableName = getTableNameFromSQL(sql);\n  \n  if (!tableName) {\n    return { data: null, error: 'Could not parse table name from SQL' };\n  }\n\n  try {\n    // Parse columns from INSERT statement\n    const insertMatch = sql.match(/insert\\s+into\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*\\(\\s*([^)]+)\\s*\\)/i);\n    if (!insertMatch) {\n      return { data: null, error: 'Could not parse INSERT statement' };\n    }\n\n    const columnsStr = insertMatch[1];\n    const columns = columnsStr.replace(/\\s/g, '').split(',');\n\n    if (!params || params.length === 0) {\n      return { data: null, error: 'INSERT query has no parameters' };\n    }\n\n    // Special handling for configuration tables\n    if (tableName === 'shipping_config' || tableName === 'tax_config') {\n      try {\n        // Create or update configuration data\n        const insertData: any = {};\n        for (let i = 0; i < columns.length && i < params.length; i++) {\n          insertData[columns[i]] = params[i];\n        }\n\n        // Use upsert to handle potential conflicts\n        const result = await supabase\n          .from(tableName)\n          .upsert(insertData, { onConflict: 'id' })\n          .select();\n\n        return result;\n      } catch (configError) {\n        console.error(`Configuration table ${tableName} insert error:`, configError);\n        return { data: null, error: configError };\n      }\n    }\n\n    // For regular tables, create the data object\n    const insertData: any = {};\n    for (let i = 0; i < columns.length && i < params.length; i++) {\n      insertData[columns[i]] = params[i];\n    }\n\n    const result = await supabase\n      .from(tableName)\n      .insert(insertData)\n      .select();\n\n    return result;\n  } catch (error: any) {\n    console.error(`Error executing INSERT query on table ${tableName}:`, error);\n    return { data: null, error };\n  }\n}\n\n// Helper function for UPDATE operations\nexport async function handleUpdateQuery(sql: string, params?: any[]): Promise<any> {\n  if (!supabase) {\n    return { data: null, error: 'Supabase client not initialized' };\n  }\n\n  const tableName = getTableNameFromSQL(sql);\n  \n  if (!tableName) {\n    return { data: null, error: 'Could not parse table name from SQL' };\n  }\n\n  try {\n    // Extract SET clause and WHERE clause\n    const updateMatch = sql.match(/update\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s+set\\s+(.*?)\\s+where\\s+(.*?)(?:\\s+returning\\s+.*)?$/i);\n    \n    if (!updateMatch) {\n      return { data: null, error: 'Could not parse UPDATE statement' };\n    }\n\n    const setClause = updateMatch[1];\n    const whereClause = updateMatch[2];\n\n    if (!params || params.length === 0) {\n      return { data: null, error: 'UPDATE query has no parameters' };\n    }\n\n    // Parse SET clause: col1=$1, col2=$2, etc.\n    const setData: any = {};\n    const setParts = setClause.split(',').map(p => p.trim());\n\n    for (let i = 0; i < setParts.length && i < params.length; i++) {\n      const [col] = setParts[i].split('='); // Only get column name from \"col=$1\"\n      setData[col.trim()] = params[i];\n    }\n\n    // Parse WHERE clause: col=$n, etc.\n    const whereConditions: any = {};\n    // Simple pattern matching for WHERE clause\n    const conditionRegex = /([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*\\$(\\d+)/g;\n    let match;\n    const paramMappings: { [key: string]: number } = {};\n\n    while ((match = conditionRegex.exec(whereClause)) !== null) {\n      const colName = match[1];\n      const paramIndex = parseInt(match[2]) - 1; // Convert $1 to index 0, etc.\n      paramMappings[colName] = paramIndex;\n      if (paramIndex < params.length) {\n        whereConditions[colName] = params[paramIndex];\n      }\n    }\n\n    // Special handling for configuration tables\n    if (tableName === 'shipping_config' || tableName === 'tax_config') {\n      try {\n        // For configuration tables, often we want to upsert or update the single record\n        const result = await supabase\n          .from(tableName)\n          .upsert(setData, { onConflict: 'id' })\n          .select();\n\n        return result;\n      } catch (configError) {\n        console.error(`Configuration table ${tableName} update error:`, configError);\n        return { data: null, error: configError };\n      }\n    }\n\n    // For regular tables, perform the update\n    const result = await supabase\n      .from(tableName)\n      .update(setData)\n      .match(whereConditions)\n      .select();\n\n    return result;\n  } catch (error: any) {\n    console.error(`Error executing UPDATE query on table ${tableName}:`, error);\n    return { data: null, error };\n  }\n}\n\n// Helper function for DELETE operations\nexport async function handleDeleteQuery(sql: string, params?: any[]): Promise<any> {\n  if (!supabase) {\n    return { data: null, error: 'Supabase client not initialized' };\n  }\n\n  const tableName = getTableNameFromSQL(sql);\n  \n  if (!tableName) {\n    return { data: null, error: 'Could not parse table name from SQL' };\n  }\n\n  try {\n    // Extract WHERE clause\n    const deleteMatch = sql.match(/delete\\s+from\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s+where\\s+(.*)/i);\n    \n    if (!deleteMatch) {\n      return { data: null, error: 'Could not parse DELETE statement' };\n    }\n\n    const whereClause = deleteMatch[1];\n\n    if (!params || params.length === 0) {\n      return { data: null, error: 'DELETE query has no parameters' };\n    }\n\n    // Special handling for configuration tables\n    if (tableName === 'shipping_config' || tableName === 'tax_config') {\n      console.warn(`DELETE operation attempted on configuration table ${tableName}. Configuration records should be updated instead.`);\n      // For configuration tables, we may not want to allow deletes, only updates\n      return { \n        data: null, \n        error: { message: `Delete operations not allowed on ${tableName}. Update the configuration instead.` } \n      };\n    }\n\n    // Parse WHERE clause: col=$n, etc.\n    const whereConditions: any = {};\n    const conditionRegex = /([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*\\$(\\d+)/g;\n    let match;\n    \n    while ((match = conditionRegex.exec(whereClause)) !== null) {\n      const colName = match[1];\n      const paramIndex = parseInt(match[2]) - 1; // Convert $1 to index 0, etc.\n      if (paramIndex < params.length) {\n        whereConditions[colName] = params[paramIndex];\n      }\n    }\n\n    const result = await supabase\n      .from(tableName)\n      .delete()\n      .match(whereConditions);\n\n    return result;\n  } catch (error: any) {\n    console.error(`Error executing DELETE query on table ${tableName}:`, error);\n    return { data: null, error };\n  }\n}"],"names":["createClient","window","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","require","config","path","supabaseUrl","supabaseAnonKey","console","error","log","supabase","QueryResult","data","rows","rowCount","formatResult","result","Array","isArray","length","getTableNameFromSQL","sql","selectMatch","match","insertMatch","updateMatch","deleteMatch","getColumnsFromSelect","trim","handleSelectQuery","params","Promise","tableName","columns","from","select","order","ascending","limit","code","message","includes","id","min_order_amount","flat_rate","enabled","created_at","Date","toISOString","rate","type","configError","hasWhere","toLowerCase","queryBuilder","whereRegex","whereMatch","whereClause","or","eq","conditionRegex","conditionMatch","parseInt","columnName","paramIndex","handleInsertQuery","columnsStr","replace","split","insertData","i","upsert","onConflict","insert","handleUpdateQuery","setClause","setData","setParts","map","p","col","whereConditions","paramMappings","key","exec","colName","update","handleDeleteQuery","warn","delete"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 463, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db.ts"],"sourcesContent":["import { supabase, formatResult, handleSelectQuery, handleInsertQuery, handleUpdateQuery, handleDeleteQuery } from './supabaseConnection';\n\n// Define types to maintain compatibility with existing code\ntype QueryResult = {\n  rows: any[];\n  rowCount: number;\n  error?: any;\n};\n\ninterface DatabasePoolInterface {\n  query: (text: string, params?: any[]) => Promise<QueryResult>;\n  connect: () => Promise<any>;\n  end: () => Promise<void>;\n}\n\n// Export a default object with an interface similar to the previous Pool\nconst db: DatabasePoolInterface = {\n  // For query function, we'll need to map SQL to database functions\n  query: async (sql: string, params?: any[]): Promise<QueryResult> => {\n    try {\n      // Basic SQL parsing to determine the type of operation\n      const sqlLower = sql.toLowerCase().trim();\n\n      if (sqlLower.startsWith('select')) {\n        try {\n          const result = await handleSelectQuery(sql, params);\n          // Format result to match expected interface\n          return formatResult(result);\n        } catch (parseError: any) {\n          // If parsing fails, return empty result\n          return { rows: [], rowCount: 0, error: parseError };\n        }\n      } else if (sqlLower.startsWith('insert')) {\n        const result = await handleInsertQuery(sql, params);\n        return formatResult(result);\n      } else if (sqlLower.startsWith('update')) {\n        const result = await handleUpdateQuery(sql, params);\n        return formatResult(result);\n      } else if (sqlLower.startsWith('delete')) {\n        const result = await handleDeleteQuery(sql, params);\n        return formatResult(result);\n      } else {\n        // For other SQL operations, we may need to use database-specific functions\n        throw new Error(`Unsupported SQL operation: ${sql.substring(0, 20)}...`);\n      }\n    } catch (error) {\n      return {\n        rows: [],\n        rowCount: 0,\n        error\n      };\n    }\n  },\n  connect: async () => {\n    // Return an object that mimics a database client for transaction support\n    const queryMethod = async (sql: string, params?: any[]): Promise<QueryResult> => {\n      return await db.query(sql, params);\n    };\n\n    return {\n      query: queryMethod,\n      release: () => {\n        // No actual connection to release\n      }\n    };\n  },\n  end: async () => {\n    // Database client doesn't require explicit connection ending\n    console.log('Database connection closed');\n  }\n};\n\nexport default db;\n\n// Test the connection\nexport const connectDB = async () => {\n  try {\n    // Perform a simple query to test the connection\n    const result = await db.query('SELECT 1 as test');\n    if (result.error && result.error.code !== 'PGRST205') {\n      console.error('Database connection error:', result.error);\n      throw result.error;\n    }\n    console.log('Database connected successfully');\n  } catch (error) {\n    console.error('Database connection error:', error);\n    throw error;\n  }\n};\n\n// Admin functions for managing shipping costs\nexport const getShippingConfig = async (): Promise<any> => {\n  try {\n    const result = await db.query(\n      'SELECT * FROM shipping_config ORDER BY created_at DESC LIMIT 1'\n    );\n    \n    if (result.rows.length > 0) {\n      return result.rows[0];\n    } else {\n      // Return default shipping configuration if none exists\n      return {\n        id: 1,\n        min_order_amount: 50000,\n        flat_rate: 1500,\n        enabled: true,\n        created_at: new Date().toISOString()\n      };\n    }\n  } catch (error) {\n    console.error('Error fetching shipping configuration:', error);\n    // Return default configuration\n    return {\n      id: 1,\n      min_order_amount: 50000,\n      flat_rate: 1500,\n      enabled: true,\n      created_at: new Date().toISOString()\n    };\n  }\n};\n\nexport const updateShippingConfig = async (config: any): Promise<any> => {\n  try {\n    const result = await db.query(\n      'INSERT INTO shipping_config (min_order_amount, flat_rate, enabled) VALUES ($1, $2, $3) ON CONFLICT (id) DO UPDATE SET min_order_amount = $1, flat_rate = $2, enabled = $3 RETURNING *',\n      [config.min_order_amount, config.flat_rate, config.enabled]\n    );\n    \n    return result;\n  } catch (error) {\n    console.error('Error updating shipping configuration:', error);\n    throw error;\n  }\n};\n\n// Admin functions for managing tax\nexport const getTaxConfig = async (): Promise<any> => {\n  try {\n    const result = await db.query(\n      'SELECT * FROM tax_config ORDER BY created_at DESC LIMIT 1'\n    );\n    \n    if (result.rows.length > 0) {\n      return result.rows[0];\n    } else {\n      // Return default tax configuration if none exists\n      return {\n        id: 1,\n        rate: 0.0,\n        type: 'percentage', // 'percentage' or 'fixed'\n        enabled: false,\n        created_at: new Date().toISOString()\n      };\n    }\n  } catch (error) {\n    console.error('Error fetching tax configuration:', error);\n    // Return default configuration\n    return {\n      id: 1,\n      rate: 0.0,\n      type: 'percentage',\n      enabled: false,\n      created_at: new Date().toISOString()\n    };\n  }\n};\n\nexport const updateTaxConfig = async (config: any): Promise<any> => {\n  try {\n    const result = await db.query(\n      'INSERT INTO tax_config (rate, type, enabled) VALUES ($1, $2, $3) ON CONFLICT (id) DO UPDATE SET rate = $1, type = $2, enabled = $3 RETURNING *',\n      [config.rate, config.type, config.enabled]\n    );\n    \n    return result;\n  } catch (error) {\n    console.error('Error updating tax configuration:', error);\n    throw error;\n  }\n};\n\n// Functions to calculate shipping and tax\nexport const calculateShippingCost = async (subtotal: number): Promise<number> => {\n  try {\n    const config = await getShippingConfig();\n    \n    if (!config.enabled) {\n      return 0; // Free shipping if disabled\n    }\n    \n    if (subtotal >= config.min_order_amount) {\n      return 0; // Free shipping for orders above threshold\n    }\n    \n    return config.flat_rate;\n  } catch (error) {\n    console.error('Error calculating shipping cost:', error);\n    // Fallback: return default shipping cost\n    return 1500;\n  }\n};\n\nexport const calculateTaxAmount = async (amount: number): Promise<number> => {\n  try {\n    const config = await getTaxConfig();\n    \n    if (!config.enabled) {\n      return 0; // No tax if disabled\n    }\n    \n    if (config.type === 'fixed') {\n      return config.rate; // Fixed tax amount\n    } else {\n      return amount * (config.rate / 100); // Percentage tax\n    }\n  } catch (error) {\n    console.error('Error calculating tax amount:', error);\n    // Fallback: return no tax\n    return 0;\n  }\n};"],"names":["supabase","formatResult","handleSelectQuery","handleInsertQuery","handleUpdateQuery","handleDeleteQuery","QueryResult","rows","rowCount","error","DatabasePoolInterface","query","text","params","Promise","connect","end","db","sql","sqlLower","toLowerCase","trim","startsWith","result","parseError","Error","substring","queryMethod","release","console","log","connectDB","code","getShippingConfig","length","id","min_order_amount","flat_rate","enabled","created_at","Date","toISOString","updateShippingConfig","config","getTaxConfig","rate","type","updateTaxConfig","calculateShippingCost","subtotal","calculateTaxAmount","amount"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 674, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/slug.ts"],"sourcesContent":["// utils/slug.ts\nimport db from '@/lib/db';\n\n/**\n * Generate a unique slug from a product name\n * \n * @param {string} name - Product name to convert to a slug\n * @param {number} [excludeId] - Product ID to exclude if updating existing product\n * @returns {Promise<string>} - Unique slug for the product\n */\nexport const generateUniqueSlug = async (name: string, excludeId?: number): Promise<string> => {\n  // Basic slugification: convert to lowercase, replace spaces with hyphens, remove special characters\n  let baseSlug = name\n    .toLowerCase()\n    .replace(/[^\\w\\s-]/g, '') // Remove special characters\n    .replace(/[\\s_-]+/g, '-') // Replace spaces, underscores, and multiple hyphens with single hyphen\n    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens\n\n  // Ensure minimum length and handle empty slug\n  if (baseSlug.length < 3) {\n    baseSlug = `product-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;\n  }\n\n  // Check if the slug already exists in the database\n  let slug = baseSlug;\n  let counter = 1;\n  let isUnique = false;\n\n  while (!isUnique) {\n    try {\n      const query = excludeId \n        ? 'SELECT id FROM products WHERE slug = $1 AND id != $2' \n        : 'SELECT id FROM products WHERE slug = $1';\n      \n      const params = excludeId ? [slug, excludeId] : [slug];\n      \n      const result = await db.query(query, params);\n      \n      if (result.rows.length === 0) {\n        // Slug is unique\n        isUnique = true;\n      } else {\n        // Slug exists, add counter and try again\n        slug = `${baseSlug}-${counter}`;\n        counter++;\n      }\n    } catch (error) {\n      console.error('Error checking slug uniqueness:', error);\n      // If there's an error, fallback to a unique slug using timestamp\n      slug = `${baseSlug}-${Date.now()}`;\n      isUnique = true;\n    }\n  }\n\n  return slug;\n};"],"names":["db","generateUniqueSlug","name","excludeId","Promise","baseSlug","toLowerCase","replace","length","Date","now","Math","random","toString","substring","slug","counter","isUnique","query","params","result","rows","error","console"],"mappings":"AAAA,gBAAA;;;;;AACA,OAAOA,EAAE,MAAM,UAAU;;AASlB,MAAMC,kBAAkB,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,GAAoB,CAAR,EAAE,MAAM,CAAC,EAAEC,OAAO,CAAC,MAAM,CAAC,IAAI;IAC7F,oGAAA;IACA,IAAIC,QAAQ,GAAGH,IAAI,CAChBI,WAAW,CAAC,CAAC,CACbC,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC,CAAC,4BAAA;KACzBA,OAAO,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC,uEAAA;KACzBA,OAAO,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC,CAAC,kCAAA;IAE5B,8CAAA;IACA,IAAIF,QAAQ,CAACG,MAAM,GAAG,CAAC,EAAE;QACvBH,QAAQ,GAAG,CAAA,QAAA,EAAWI,IAAI,CAACC,GAAG,CAAC,CAAC,CAAA,CAAA,EAAIC,IAAI,CAACC,MAAM,CAAC,CAAC,CAACC,QAAQ,CAAC,EAAE,CAAC,CAACC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;IAClF;IAEA,mDAAA;IACA,IAAIC,IAAI,GAAGV,QAAQ;IACnB,IAAIW,OAAO,GAAG,CAAC;IACf,IAAIC,QAAQ,GAAG,KAAK;IAEpB,MAAO,CAACA,QAAQ,CAAE;QAChB,IAAI;YACF,MAAMC,KAAK,GAAGf,SAAS,GACnB,sDAAsD,GACtD,yCAAyC;YAE7C,MAAMgB,MAAM,GAAGhB,SAAS,GAAG;gBAACY,IAAI;gBAAEZ,SAAS;aAAC,GAAG;gBAACY,IAAI;aAAC;YAErD,MAAMK,MAAM,GAAG,MAAMpB,6HAAE,CAACkB,KAAK,CAACA,KAAK,EAAEC,MAAM,CAAC;YAE5C,IAAIC,MAAM,CAACC,IAAI,CAACb,MAAM,KAAK,CAAC,EAAE;gBAC5B,iBAAA;gBACAS,QAAQ,GAAG,IAAI;YACjB,CAAC,MAAM;gBACL,yCAAA;gBACAF,IAAI,GAAG,GAAGV,QAAQ,CAAA,CAAA,EAAIW,OAAO,EAAE;gBAC/BA,OAAO,EAAE;YACX;QACF,CAAC,CAAC,OAAOM,KAAK,EAAE;YACdC,OAAO,CAACD,KAAK,CAAC,iCAAiC,EAAEA,KAAK,CAAC;YACvD,iEAAA;YACAP,IAAI,GAAG,GAAGV,QAAQ,CAAA,CAAA,EAAII,IAAI,CAACC,GAAG,CAAC,CAAC,EAAE;YAClCO,QAAQ,GAAG,IAAI;QACjB;IACF;IAEA,OAAOF,IAAI;AACb,CAAC","ignoreList":[],"debugId":null}},
    {"offset": {"line": 725, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/products/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport db from '@/lib/db';\nimport { generateUniqueSlug } from '@/lib/slug';\n\n// Handle preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return NextResponse.json({}, {\n    headers: {\n      \"Access-Control-Allow-Credentials\": \"true\",\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n      \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n    },\n  });\n}\n\nexport async function GET(_request: NextRequest) {\n  try {\n    // Get products with their associated images\n    const productsResult = await db.query('SELECT * FROM products');\n\n    // For each product, try to fetch its associated images\n    // Handle case where product_images table might not exist yet\n    const productsWithImages = await Promise.all(productsResult.rows.map(async (product) => {\n      try {\n        const imagesResult = await db.query(\n          'SELECT image_url, is_primary, sort_order FROM product_images WHERE product_id = $1 ORDER BY sort_order',\n          [product.id]\n        );\n\n        return {\n          ...product,\n          images: imagesResult.rows.map((img: any) => img.image_url),\n          primary_image: imagesResult.rows.find((img: any) => img.is_primary)?.image_url || product.image_url\n        };\n      } catch (imageError) {\n        // If product_images table doesn't exist, return product with just the original image_url\n        console.warn(`Could not fetch images for product ${product.id}:`, (imageError as Error).message || imageError);\n        return {\n          ...product,\n          images: product.image_url ? [product.image_url] : [],\n          primary_image: product.image_url\n        };\n      }\n    }));\n\n    return NextResponse.json({\n      success: true,\n      data: productsWithImages\n    }, {\n      headers: {\n        \"Access-Control-Allow-Credentials\": \"true\",\n        \"Access-Control-Allow-Origin\": \"*\",\n        \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n        \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n      },\n    });\n  } catch (error) {\n    console.error('Error fetching products:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error'\n      },\n      {\n        status: 500,\n        headers: {\n          \"Access-Control-Allow-Credentials\": \"true\",\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n          \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n        },\n      }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { name, description, price, image_url, image_urls, category } = body;\n\n    if (!name || !description || !price || price <= 0) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Name, description, and price are required'\n        },\n        {\n          status: 400,\n          headers: {\n            \"Access-Control-Allow-Credentials\": \"true\",\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n          },\n        }\n      );\n    }\n\n    // Start a transaction to ensure data consistency\n    const client = await db.connect();\n    try {\n      await client.query('BEGIN');\n\n      // Generate a unique slug for the product\n      const slug = await generateUniqueSlug(name);\n      \n      // Create the product first\n      const productResult = await client.query(\n        'INSERT INTO products (name, description, price, image_url, category, slug) VALUES ($1, $2, $3, $4, $5, $6) RETURNING *',\n        [name, description, price, image_url, category, slug]\n      );\n\n      const product = productResult.rows[0];\n\n      // If multiple images are provided, add them to the product_images table\n      if (Array.isArray(image_urls) && image_urls.length > 0) {\n        try {\n          for (let i = 0; i < image_urls.length; i++) {\n            const isPrimary = i === 0; // Make the first image primary by default\n            await client.query(\n              'INSERT INTO product_images (product_id, image_url, is_primary, sort_order) VALUES ($1, $2, $3, $4)',\n              [product.id, image_urls[i], isPrimary, i]\n            );\n          }\n        } catch (insertError) {\n          console.warn(`Could not insert images for product ${product.id}:`, (insertError as Error).message || insertError);\n        }\n      } else if (image_url) {\n        // If only a single image is provided, add it as a primary image\n        try {\n          await client.query(\n            'INSERT INTO product_images (product_id, image_url, is_primary, sort_order) VALUES ($1, $2, $3, $4)',\n            [product.id, image_url, true, 0]\n          );\n        } catch (insertError) {\n          console.warn(`Could not insert image for product ${product.id}:`, (insertError as Error).message || insertError);\n        }\n      }\n\n      await client.query('COMMIT');\n\n      // Fetch the product with its images to return\n      // Handle case where product_images table might not exist yet\n      let productWithImages;\n      try {\n        const imagesResult = await client.query(\n          'SELECT image_url, is_primary, sort_order FROM product_images WHERE product_id = $1 ORDER BY sort_order',\n          [product.id]\n        );\n\n        productWithImages = {\n          ...product,\n          images: imagesResult.rows.map((img: any) => img.image_url),\n          primary_image: imagesResult.rows.find((img: any) => img.is_primary)?.image_url || product.image_url\n        };\n      } catch (imageError) {\n        // If product_images table doesn't exist, return product with just the original image_url\n        console.warn(`Could not fetch images for product ${product.id}:`, (imageError as Error).message || imageError);\n        productWithImages = {\n          ...product,\n          images: product.image_url ? [product.image_url] : [],\n          primary_image: product.image_url\n        };\n      }\n\n      return NextResponse.json(\n        {\n          success: true,\n          data: productWithImages\n        },\n        {\n          status: 201,\n          headers: {\n            \"Access-Control-Allow-Credentials\": \"true\",\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n          },\n        }\n      );\n    } catch (error) {\n      await client.query('ROLLBACK');\n      throw error;\n    } finally {\n      client.release();\n    }\n  } catch (error) {\n    console.error('Error creating product:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error'\n      },\n      {\n        status: 500,\n        headers: {\n          \"Access-Control-Allow-Credentials\": \"true\",\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n          \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n        },\n      }\n    );\n  }\n}"],"names":["NextRequest","NextResponse","db","generateUniqueSlug","OPTIONS","request","json","headers","GET","_request","productsResult","query","productsWithImages","Promise","all","rows","map","product","imagesResult","id","images","img","image_url","primary_image","find","is_primary","imageError","console","warn","Error","message","success","data","error","status","POST","body","name","description","price","image_urls","category","client","connect","slug","productResult","Array","isArray","length","i","isPrimary","insertError","productWithImages","release"],"mappings":"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","ignoreList":[],"debugId":null}}]
}