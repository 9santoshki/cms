{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport bcrypt from 'bcryptjs';\nimport { createClient } from '@supabase/supabase-js';\nimport { z } from 'zod';\nimport jwt from 'jsonwebtoken';\n\n// Initialize Supabase client\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY;\nconst jwtSecret = process.env.JWT_SECRET;\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  console.error('Error: Supabase environment variables not set');\n  console.log('Please make sure .env.local file contains:');\n  console.log('NEXT_PUBLIC_SUPABASE_URL=');\n  console.log('NEXT_PUBLIC_SUPABASE_ANON_KEY=');\n  throw new Error('Missing Supabase configuration in environment variables');\n}\n\nif (!jwtSecret) {\n  console.error('Error: JWT secret not set');\n  console.log('Please make sure .env.local file contains:');\n  console.log('JWT_SECRET=');\n  throw new Error('Missing JWT_SECRET in environment variables');\n}\n\nconst supabase = createClient(supabaseUrl, supabaseAnonKey);\n\n// Handle preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return NextResponse.json({}, {\n    headers: {\n      \"Access-Control-Allow-Credentials\": \"true\",\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n      \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n    },\n  });\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { email, password } = await request.json();\n\n    if (!email || !password) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Email and password are required'\n        },\n        {\n          status: 400,\n          headers: {\n            \"Access-Control-Allow-Credentials\": \"true\",\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n          },\n        }\n      );\n    }\n\n    // Validate email format using zod\n    const emailValidation = z.string().email();\n    const validationResult = emailValidation.safeParse(email);\n\n    if (!validationResult.success) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Invalid email format'\n        },\n        {\n          status: 400,\n          headers: {\n            \"Access-Control-Allow-Credentials\": \"true\",\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n          },\n        }\n      );\n    }\n\n    try {\n      // Check if user exists in database and verify password\n      const { data: users, error } = await supabase\n        .from('users')\n        .select('id, email, name, encrypted_password, role, created_at')\n        .eq('email', email)\n        .single(); // Use single() to get just one user\n\n      if (error || !users) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: 'Invalid email or password'\n          },\n          {\n            status: 401,\n            headers: {\n              \"Access-Control-Allow-Credentials\": \"true\",\n              \"Access-Control-Allow-Origin\": \"*\",\n              \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n              \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n            },\n          }\n        );\n      }\n\n      // Verify password using bcrypt\n      const isPasswordValid = await bcrypt.compare(password, users.encrypted_password);\n\n      if (!isPasswordValid) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: 'Invalid email or password'\n          },\n          {\n            status: 401,\n            headers: {\n              \"Access-Control-Allow-Credentials\": \"true\",\n              \"Access-Control-Allow-Origin\": \"*\",\n              \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n              \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n            },\n          }\n        );\n      }\n\n      // Password is valid, create user object for response\n      const user = {\n        id: users.id,\n        name: users.name || email.split('@')[0], // Fallback to email username if name is missing\n        email: users.email,\n        role: users.role || 'user',\n        created_at: users.created_at\n      };\n\n      // Create a real JWT token\n      const token = jwt.sign(\n        { \n          id: user.id, \n          email: user.email, \n          role: user.role \n        },\n        jwtSecret,\n        { expiresIn: '24h' } // Token expires in 24 hours\n      );\n\n      return NextResponse.json(\n        {\n          success: true,\n          data: { user, token }\n        },\n        {\n          status: 200,\n          headers: {\n            \"Access-Control-Allow-Credentials\": \"true\",\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n          },\n        }\n      );\n\n    } catch (dbError: any) {\n      console.error('Database error during login:', dbError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Database error'\n        },\n        {\n          status: 500,\n          headers: {\n            \"Access-Control-Allow-Credentials\": \"true\",\n            \"Access-Control-Allow-Origin\": \"*\",\n            \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n            \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n          },\n        }\n      );\n    }\n  } catch (error) {\n    console.error('Login error:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error'\n      },\n      {\n        status: 500,\n        headers: {\n          \"Access-Control-Allow-Credentials\": \"true\",\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Access-Control-Allow-Methods\": \"GET,DELETE,PATCH,POST,PUT,OPTIONS\",\n          \"Access-Control-Allow-Headers\": \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization\",\n        },\n      }\n    );\n  }\n}"],"names":["NextRequest","NextResponse","bcrypt","createClient","z","jwt","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_URL","supabaseAnonKey","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_ANON_KEY","jwtSecret","JWT_SECRET","console","error","log","Error","supabase","OPTIONS","request","json","headers","POST","email","password","success","status","emailValidation","string","validationResult","safeParse","data","users","from","select","eq","single","isPasswordValid","compare","encrypted_password","user","id","name","split","role","created_at","token","sign","expiresIn","dbError"],"mappings":"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","ignoreList":[],"debugId":null}}]
}