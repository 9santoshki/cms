{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/connection.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  host: process.env.DB_HOST || 'localhost',\n  port: parseInt(process.env.DB_PORT || '5432'),\n  database: process.env.DB_NAME || 'cmsdb',\n  user: process.env.DB_USER || 'sk',\n  password: process.env.DB_PASSWORD || 'sk',\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n  process.exit(-1);\n});\n\nexport const query = async (text: string, params?: any[]) => {\n  const start = Date.now();\n  try {\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('Executed query', { text, duration, rows: res.rowCount });\n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n};\n\nexport const getClient = async (): Promise<PoolClient> => {\n  const client = await pool.connect();\n  return client;\n};\n\nexport default pool;\n"],"names":["Pool","PoolClient","pool","host","process","env","DB_HOST","port","parseInt","DB_PORT","database","DB_NAME","user","DB_USER","password","DB_PASSWORD","max","idleTimeoutMillis","connectionTimeoutMillis","on","err","console","error","exit","query","text","params","start","Date","now","res","duration","log","rows","rowCount","getClient","Promise","client","connect"],"mappings":";;;;;;;;AAAA,SAASA,IAAI,EAAEC,UAAU,QAAQ,IAAI;;;;;;AAErC,2BAAA;AACA,MAAMC,IAAI,GAAG,IAAIF,4GAAI,CAAC;IACpBG,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,OAAO,IAAI,WAAW;IACxCC,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAG,CAACI,OAAO,IAAI,MAAM,CAAC;IAC7CC,QAAQ,EAAEN,OAAO,CAACC,GAAG,CAACM,OAAO,IAAI,OAAO;IACxCC,IAAI,EAAER,OAAO,CAACC,GAAG,CAACQ,OAAO,IAAI,IAAI;IACjCC,QAAQ,EAAEV,OAAO,CAACC,GAAG,CAACU,WAAW,IAAI,IAAI;IACzCC,GAAG,EAAE,EAAE;IACPC,iBAAiB,EAAE,KAAK;IACxBC,uBAAuB,EAAE;AAC3B,CAAC,CAAC;AAEFhB,IAAI,CAACiB,EAAE,CAAC,OAAO,GAAGC,GAAG,IAAK;IACxBC,OAAO,CAACC,KAAK,CAAC,iCAAiC,EAAEF,GAAG,CAAC;IACrDhB,OAAO,CAACmB,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEK,MAAMC,KAAK,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,AAAgB,CAAP,EAAE,GAAG,EAAE,KAAK;IAC3D,MAAMC,KAAK,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC;IACxB,IAAI;QACF,MAAMC,GAAG,GAAG,MAAM5B,IAAI,CAACsB,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;QAC1C,MAAMK,QAAQ,GAAGH,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGF,KAAK;QACnCN,OAAO,CAACW,GAAG,CAAC,gBAAgB,EAAE;YAAEP,IAAI;YAAEM,QAAQ;YAAEE,IAAI,EAAEH,GAAG,CAACI,QAAAA;QAAS,CAAC,CAAC;QACrE,OAAOJ,GAAG;IACZ,CAAC,CAAC,OAAOR,KAAK,EAAE;QACdD,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC7C,MAAMA,KAAK;IACb;AACF,CAAC;AAEM,MAAMa,SAAS,GAAG,MAAAA,CAAA,CAAQ,EAAEC,OAAO,CAACnC,UAAU,CAAC,IAAI;IACxD,MAAMoC,MAAM,GAAG,MAAMnC,IAAI,CAACoC,OAAO,CAAC,CAAC;IACnC,OAAOD,MAAM;AACf,CAAC;uCAEcnC,IAAI","ignoreList":[],"debugId":null}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/auth/set-session/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { query } from '@/lib/db/connection';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const tempToken = searchParams.get('token');\n\n    console.log('üîÑ Set-session route called with token:', tempToken ? 'present' : 'missing');\n\n    if (!tempToken) {\n      console.error('‚ùå No temp token provided');\n      return NextResponse.redirect(new URL('/?error=no_token', request.url));\n    }\n\n    // Retrieve session token from temporary storage\n    const result = await query(\n      'SELECT session_token FROM temp_auth_tokens WHERE temp_token = $1 AND expires_at > NOW()',\n      [tempToken]\n    );\n\n    console.log('üîç Temp token lookup result:', result.rows.length, 'rows');\n\n    if (result.rows.length === 0) {\n      console.error('‚ùå Invalid or expired temp token');\n      return NextResponse.redirect(new URL('/?error=invalid_token', request.url));\n    }\n\n    const sessionToken = result.rows[0].session_token;\n    console.log('‚úÖ Found session token, length:', sessionToken.length);\n\n    // Delete the temporary token\n    await query('DELETE FROM temp_auth_tokens WHERE temp_token = $1', [tempToken]);\n    console.log('üóëÔ∏è Deleted temp token');\n\n    // Build cookie string manually (bypass Next.js cookie API)\n    const maxAge = 60 * 60 * 24 * 30; // 30 days\n    const secure = process.env.NODE_ENV === 'production';\n\n    const cookieString = [\n      `cms-session=${sessionToken}`,\n      `Max-Age=${maxAge}`,\n      `Path=/`,\n      `SameSite=Lax`,\n      secure ? 'Secure' : null,\n      'HttpOnly'\n    ].filter(Boolean).join('; ');\n\n    console.log('‚úÖ‚úÖ‚úÖ Setting cookie with raw header!');\n    console.log('Cookie string length:', cookieString.length);\n\n    // Return HTML page that sets cookie via JavaScript and redirects\n    // Using JavaScript to set cookie since HTTP headers aren't working\n    const html = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <title>Login Successful</title>\n        </head>\n        <body>\n          <h2>Login successful! Setting session...</h2>\n          <script>\n            console.log('üîÑ Setting session cookie via JavaScript...');\n\n            // Set cookie via JavaScript (not HttpOnly, but it will work!)\n            var expires = new Date();\n            expires.setTime(expires.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days\n            document.cookie = \"cms-session=${sessionToken.replace(/\"/g, '\\\\\"')}; expires=\" + expires.toUTCString() + \"; path=/; SameSite=Lax\";\n\n            console.log('‚úÖ Cookie set! Redirecting...');\n            console.log('Cookie value:', document.cookie);\n\n            // Redirect immediately for fast header loading\n            console.log('üîÑ Redirecting to homepage...');\n            window.location.href = '/';\n          </script>\n        </body>\n      </html>\n    `;\n\n    const response = new NextResponse(html, {\n      status: 200,\n      headers: {\n        'Content-Type': 'text/html',\n        'Set-Cookie': cookieString,\n      },\n    });\n\n    console.log('üîÑ Returning HTML page with cookie header...');\n\n    return response;\n  } catch (error) {\n    console.error('‚ùå Error in set-session:', error);\n    return NextResponse.redirect(new URL('/?error=auth_failed', request.url));\n  }\n}\n"],"names":["NextRequest","NextResponse","query","GET","request","searchParams","nextUrl","tempToken","get","console","log","error","redirect","URL","url","result","rows","length","sessionToken","session_token","maxAge","secure","process","env","NODE_ENV","cookieString","filter","Boolean","join","html","replace","response","status","headers"],"mappings":"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","ignoreList":[],"debugId":null}}]
}