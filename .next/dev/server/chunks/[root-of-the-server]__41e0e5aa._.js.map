{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/connection.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  host: process.env.DB_HOST || 'localhost',\n  port: parseInt(process.env.DB_PORT || '5432'),\n  database: process.env.DB_NAME || 'cmsdb',\n  user: process.env.DB_USER || 'sk',\n  password: process.env.DB_PASSWORD || 'sk',\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n  process.exit(-1);\n});\n\nexport const query = async (text: string, params?: any[]) => {\n  try {\n    const res = await pool.query(text, params);\n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n};\n\nexport const getClient = async (): Promise<PoolClient> => {\n  const client = await pool.connect();\n  return client;\n};\n\nexport default pool;\n"],"names":["Pool","PoolClient","pool","host","process","env","DB_HOST","port","parseInt","DB_PORT","database","DB_NAME","user","DB_USER","password","DB_PASSWORD","max","idleTimeoutMillis","connectionTimeoutMillis","on","err","console","error","exit","query","text","params","res","getClient","Promise","client","connect"],"mappings":";;;;;;;;AAAA,SAASA,IAAI,EAAEC,UAAU,QAAQ,IAAI;;;;;;AAErC,2BAAA;AACA,MAAMC,IAAI,GAAG,IAAIF,4GAAI,CAAC;IACpBG,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,OAAO,IAAI,WAAW;IACxCC,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAG,CAACI,OAAO,IAAI,MAAM,CAAC;IAC7CC,QAAQ,EAAEN,OAAO,CAACC,GAAG,CAACM,OAAO,IAAI,OAAO;IACxCC,IAAI,EAAER,OAAO,CAACC,GAAG,CAACQ,OAAO,IAAI,IAAI;IACjCC,QAAQ,EAAEV,OAAO,CAACC,GAAG,CAACU,WAAW,IAAI,IAAI;IACzCC,GAAG,EAAE,EAAE;IACPC,iBAAiB,EAAE,KAAK;IACxBC,uBAAuB,EAAE;AAC3B,CAAC,CAAC;AAEFhB,IAAI,CAACiB,EAAE,CAAC,OAAO,GAAGC,GAAG,IAAK;IACxBC,OAAO,CAACC,KAAK,CAAC,iCAAiC,EAAEF,GAAG,CAAC;IACrDhB,OAAO,CAACmB,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEK,MAAMC,KAAK,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,AAAgB,CAAP,EAAE,GAAG,EAAE,KAAK;IAC3D,IAAI;QACF,MAAMC,GAAG,GAAG,MAAMzB,IAAI,CAACsB,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;QAC1C,OAAOC,GAAG;IACZ,CAAC,CAAC,OAAOL,KAAK,EAAE;QACdD,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC7C,MAAMA,KAAK;IACb;AACF,CAAC;AAEM,MAAMM,SAAS,GAAG,MAAAA,CAAA,CAAQ,EAAEC,OAAO,CAAC5B,UAAU,CAAC,IAAI;IACxD,MAAM6B,MAAM,GAAG,MAAM5B,IAAI,CAAC6B,OAAO,CAAC,CAAC;IACnC,OAAOD,MAAM;AACf,CAAC;uCAEc5B,IAAI","ignoreList":[],"debugId":null}},
    {"offset": {"line": 132, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/auth.ts"],"sourcesContent":["import { query } from './connection';\nimport { cookies, headers } from 'next/headers';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\nconst SESSION_COOKIE_NAME = 'cms-session';\nconst SESSION_DURATION_DAYS = 30; // 30 days for persistent login\n\nexport interface UserProfile {\n  id: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: 'customer' | 'moderator' | 'admin';\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface SessionData {\n  userId: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: string;\n  sessionId?: string; // Database session ID\n}\n\nexport interface DBSession {\n  id: string;\n  user_id: string;\n  session_token: string;\n  refresh_token?: string;\n  user_agent?: string;\n  ip_address?: string;\n  expires_at: string;\n  created_at: string;\n  updated_at: string;\n  last_activity: string;\n}\n\n// Create or update user from Google OAuth\nexport const upsertUserFromGoogle = async (googleUser: {\n  id: string;\n  email: string;\n  name: string;\n  picture?: string;\n}): Promise<UserProfile> => {\n  // Check if user exists\n  const existingUser = await query(\n    'SELECT * FROM users WHERE email = $1',\n    [googleUser.email]\n  );\n\n  let userId: string;\n\n  if (existingUser.rows.length > 0) {\n    // Update existing user\n    userId = existingUser.rows[0].id;\n    await query(\n      `UPDATE users\n       SET name = $1, avatar = $2, google_id = $3, updated_at = NOW()\n       WHERE id = $4`,\n      [googleUser.name, googleUser.picture, googleUser.id, userId]\n    );\n  } else {\n    // Create new user\n    const newUser = await query(\n      `INSERT INTO users (email, name, avatar, google_id, role)\n       VALUES ($1, $2, $3, $4, 'customer')\n       RETURNING id`,\n      [googleUser.email, googleUser.name, googleUser.picture, googleUser.id]\n    );\n    userId = newUser.rows[0].id;\n  }\n\n  // Get the complete user profile\n  const userProfile = await getUserProfile(userId);\n  if (!userProfile) {\n    throw new Error('Failed to create or fetch user profile');\n  }\n\n  return userProfile;\n};\n\n// Get user profile by ID\nexport const getUserProfile = async (userId: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE id = $1',\n    [userId]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Get user profile by email\nexport const getUserByEmail = async (email: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE email = $1',\n    [email]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Create session token\nexport const createSessionToken = (user: UserProfile): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: '7d' });\n};\n\n// Verify session token\nexport const verifySessionToken = (token: string): SessionData | null => {\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as SessionData;\n    return decoded;\n  } catch (error) {\n    console.error('Invalid token:', error);\n    return null;\n  }\n};\n\n// Set session cookie\nexport const setSessionCookie = async (token: string) => {\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7, // 7 days\n    path: '/',\n  });\n};\n\n// Get session from cookie\nexport const getSessionFromCookie = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  return verifySessionToken(sessionCookie.value);\n};\n\n// Clear session cookie\nexport const clearSessionCookie = async () => {\n  const cookieStore = await cookies();\n  cookieStore.delete(SESSION_COOKIE_NAME);\n};\n\n// Update user role (admin only)\nexport const updateUserRole = async (\n  userId: string,\n  newRole: 'customer' | 'moderator' | 'admin'\n): Promise<void> => {\n  await query(\n    'UPDATE users SET role = $1, updated_at = NOW() WHERE id = $2',\n    [newRole, userId]\n  );\n};\n\n// Get all user profiles (admin only)\nexport const getAllUserProfiles = async (): Promise<UserProfile[]> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users ORDER BY created_at DESC'\n  );\n\n  return result.rows;\n};\n\n// Update user profile\nexport const updateUserProfile = async (\n  userId: string,\n  updates: { name?: string; avatar?: string }\n): Promise<UserProfile | null> => {\n  const fields: string[] = [];\n  const values: any[] = [];\n  let paramCount = 1;\n\n  if (updates.name !== undefined) {\n    fields.push(`name = $${paramCount++}`);\n    values.push(updates.name);\n  }\n\n  if (updates.avatar !== undefined) {\n    fields.push(`avatar = $${paramCount++}`);\n    values.push(updates.avatar);\n  }\n\n  if (fields.length === 0) {\n    return getUserProfile(userId);\n  }\n\n  fields.push(`updated_at = NOW()`);\n  values.push(userId);\n\n  await query(\n    `UPDATE users SET ${fields.join(', ')} WHERE id = $${paramCount}`,\n    values\n  );\n\n  return getUserProfile(userId);\n};\n\n// ============================================================================\n// SESSION MANAGEMENT (Database-backed persistent sessions)\n// ============================================================================\n\n// Generate secure random token\nconst generateSecureToken = (): string => {\n  return crypto.randomBytes(32).toString('hex');\n};\n\n// Get request metadata (user agent, IP)\nconst getRequestMetadata = async () => {\n  try {\n    const headersList = await headers();\n    const userAgent = (await headersList).get('user-agent') || undefined;\n    const forwardedFor = (await headersList).get('x-forwarded-for');\n    const realIp = (await headersList).get('x-real-ip');\n    const ipAddress = forwardedFor?.split(',')[0] || realIp || undefined;\n\n    return { userAgent, ipAddress };\n  } catch (error) {\n    return { userAgent: undefined, ipAddress: undefined };\n  }\n};\n\n// Create a new session in the database\nexport const createSession = async (\n  user: UserProfile,\n  rememberMe: boolean = true\n): Promise<{ sessionToken: string; refreshToken: string; dbSession: DBSession }> => {\n  const sessionToken = generateSecureToken();\n  const refreshToken = generateSecureToken();\n  const { userAgent, ipAddress } = await getRequestMetadata();\n\n  // Calculate expiration based on remember me option\n  const durationDays = rememberMe ? SESSION_DURATION_DAYS : 1; // 30 days or 1 day\n  const expiresAt = new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000);\n\n  const result = await query(\n    `INSERT INTO sessions (user_id, session_token, refresh_token, user_agent, ip_address, expires_at)\n     VALUES ($1, $2, $3, $4, $5, $6)\n     RETURNING *`,\n    [user.id, sessionToken, refreshToken, userAgent, ipAddress, expiresAt]\n  );\n\n  return {\n    sessionToken,\n    refreshToken,\n    dbSession: result.rows[0]\n  };\n};\n\n// Get session from database by token\nexport const getSessionFromDB = async (sessionToken: string): Promise<DBSession | null> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE session_token = $1\n     AND expires_at > NOW()`,\n    [sessionToken]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Update session activity timestamp\nexport const updateSessionActivity = async (sessionId: string): Promise<void> => {\n  await query(\n    'UPDATE sessions SET last_activity = NOW() WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Delete a specific session\nexport const deleteSession = async (sessionToken: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE session_token = $1',\n    [sessionToken]\n  );\n};\n\n// Delete all sessions for a user\nexport const deleteUserSessions = async (userId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE user_id = $1',\n    [userId]\n  );\n};\n\n// Delete a specific session by ID\nexport const deleteSessionById = async (sessionId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Clean up expired sessions\nexport const cleanupExpiredSessions = async (): Promise<number> => {\n  const result = await query('SELECT cleanup_expired_sessions()');\n  return result.rows[0].cleanup_expired_sessions;\n};\n\n// Get all active sessions for a user\nexport const getUserSessions = async (userId: string): Promise<DBSession[]> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE user_id = $1\n     AND expires_at > NOW()\n     ORDER BY last_activity DESC`,\n    [userId]\n  );\n\n  return result.rows;\n};\n\n// Enhanced session token creation with database session ID\nexport const createSessionTokenWithDB = (user: UserProfile, sessionId: string): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n    sessionId: sessionId, // Include DB session ID in JWT\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: `${SESSION_DURATION_DAYS}d` });\n};\n\n// Enhanced session validation (checks both JWT and database)\nexport const validateSession = async (token: string): Promise<SessionData | null> => {\n  // First verify JWT\n  const jwtData = verifySessionToken(token);\n  if (!jwtData) {\n    return null;\n  }\n\n  // If JWT has session ID, verify against database\n  if (jwtData.sessionId) {\n    const dbSession = await query(\n      'SELECT * FROM sessions WHERE id = $1 AND expires_at > NOW()',\n      [jwtData.sessionId]\n    );\n\n    if (dbSession.rows.length === 0) {\n      // Session was invalidated in database\n      return null;\n    }\n\n    // Update last activity\n    await updateSessionActivity(jwtData.sessionId);\n  }\n\n  return jwtData;\n};\n\n// Enhanced get session from cookie with database validation\nexport const getSessionFromCookieWithDB = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  // Validate against database as well\n  return validateSession(sessionCookie.value);\n};\n\n// Enhanced set session cookie with longer duration\nexport const setSessionCookieWithDB = async (token: string, rememberMe: boolean = true) => {\n  const cookieStore = await cookies();\n  const maxAge = rememberMe\n    ? 60 * 60 * 24 * SESSION_DURATION_DAYS  // 30 days\n    : 60 * 60 * 24; // 1 day\n\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: maxAge,\n    path: '/',\n  });\n};\n\n// Enhanced logout that clears both cookie and database session\nexport const logoutSession = async (): Promise<void> => {\n  const session = await getSessionFromCookieWithDB();\n\n  // Clear cookie\n  await clearSessionCookie();\n\n  // Delete from database if session ID exists\n  if (session?.sessionId) {\n    await deleteSessionById(session.sessionId);\n  }\n};\n"],"names":["query","cookies","headers","jwt","crypto","JWT_SECRET","process","env","SESSION_COOKIE_NAME","SESSION_DURATION_DAYS","UserProfile","id","email","name","avatar","role","created_at","updated_at","SessionData","userId","sessionId","DBSession","user_id","session_token","refresh_token","user_agent","ip_address","expires_at","last_activity","upsertUserFromGoogle","googleUser","picture","Promise","existingUser","rows","length","newUser","userProfile","getUserProfile","Error","result","getUserByEmail","createSessionToken","user","sessionData","sign","expiresIn","verifySessionToken","token","decoded","verify","error","console","setSessionCookie","cookieStore","set","httpOnly","secure","NODE_ENV","sameSite","maxAge","path","getSessionFromCookie","sessionCookie","get","value","clearSessionCookie","delete","updateUserRole","newRole","getAllUserProfiles","updateUserProfile","updates","fields","values","paramCount","undefined","push","join","generateSecureToken","randomBytes","toString","getRequestMetadata","headersList","userAgent","forwardedFor","realIp","ipAddress","split","createSession","rememberMe","sessionToken","refreshToken","dbSession","durationDays","expiresAt","Date","now","getSessionFromDB","updateSessionActivity","deleteSession","deleteUserSessions","deleteSessionById","cleanupExpiredSessions","cleanup_expired_sessions","getUserSessions","createSessionTokenWithDB","validateSession","jwtData","getSessionFromCookieWithDB","setSessionCookieWithDB","logoutSession","session"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 488, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/auth/session/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getSessionFromCookieWithDB, getUserProfile } from '@/lib/db/auth';\n\nexport async function GET(request: NextRequest) {\n  try {\n    console.log('=== SESSION API CALLED ===');\n    console.log('Cookies:', request.cookies.getAll());\n    console.log('Has cms-session cookie:', request.cookies.has('cms-session'));\n\n    // Use database-backed session validation\n    const session = await getSessionFromCookieWithDB();\n    console.log('Session from cookie:', session ? {\n      userId: session.userId,\n      email: session.email,\n      name: session.name,\n      avatar: session.avatar,\n      avatarLength: session.avatar?.length,\n      role: session.role,\n      sessionId: session.sessionId\n    } : 'NULL');\n\n    if (!session) {\n      console.log('No session found, returning null user');\n      return NextResponse.json({ user: null }, { status: 200 });\n    }\n\n    // Get fresh user data from database\n    const userProfile = await getUserProfile(session.userId);\n    console.log('User profile from DB:', userProfile ? {\n      id: userProfile.id,\n      email: userProfile.email,\n      name: userProfile.name,\n      hasAvatar: !!userProfile.avatar,\n      avatar: userProfile.avatar\n    } : 'NULL');\n\n    if (!userProfile) {\n      console.log('No user profile found, returning null user');\n      return NextResponse.json({ user: null }, { status: 200 });\n    }\n\n    const userData = {\n      id: userProfile.id,\n      email: userProfile.email,\n      name: userProfile.name,\n      avatar: userProfile.avatar,\n      role: userProfile.role,\n    };\n\n    console.log('✅ Session API - Returning user data with avatar:', {\n      ...userData,\n      avatarLength: userData.avatar?.length || 0\n    });\n\n    return NextResponse.json({\n      user: userData,\n    });\n  } catch (error) {\n    console.error('❌ Error getting session:', error);\n    return NextResponse.json({ user: null }, { status: 200 });\n  }\n}\n"],"names":["NextRequest","NextResponse","getSessionFromCookieWithDB","getUserProfile","GET","request","console","log","cookies","getAll","has","session","userId","email","name","avatar","avatarLength","length","role","sessionId","json","user","status","userProfile","id","hasAvatar","userData","error"],"mappings":";;;;AAAA,SAASA,WAAW,EAAEC,YAAY,QAAQ,aAAa;AACvD,SAASC,0BAA0B,EAAEC,cAAc,QAAQ,eAAe;;;;;;;AAEnE,eAAeC,GAAGA,CAACC,OAAO,AAAa,EAAXL,AAAa;IAC9C,IAAI;QACFM,OAAO,CAACC,GAAG,CAAC,4BAA4B,CAAC;QACzCD,OAAO,CAACC,GAAG,CAAC,UAAU,EAAEF,OAAO,CAACG,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC;QACjDH,OAAO,CAACC,GAAG,CAAC,yBAAyB,EAAEF,OAAO,CAACG,OAAO,CAACE,GAAG,CAAC,aAAa,CAAC,CAAC;QAE1E,yCAAA;QACA,MAAMC,OAAO,GAAG,UAAMT,wJAA0B,CAAC,CAAC;QAClDI,OAAO,CAACC,GAAG,CAAC,sBAAsB,EAAEI,OAAO,GAAG;YAC5CC,MAAM,EAAED,OAAO,CAACC,MAAM;YACtBC,KAAK,EAAEF,OAAO,CAACE,KAAK;YACpBC,IAAI,EAAEH,OAAO,CAACG,IAAI;YAClBC,MAAM,EAAEJ,OAAO,CAACI,MAAM;YACtBC,YAAY,EAAEL,OAAO,CAACI,MAAM,EAAEE,MAAM;YACpCC,IAAI,EAAEP,OAAO,CAACO,IAAI;YAClBC,SAAS,EAAER,OAAO,CAACQ,SAAAA;QACrB,CAAC,GAAG,MAAM,CAAC;QAEX,IAAI,CAACR,OAAO,EAAE;YACZL,OAAO,CAACC,GAAG,CAAC,uCAAuC,CAAC;YACpD,OAAON,gJAAY,CAACmB,IAAI,CAAC;gBAAEC,IAAI,EAAE;YAAK,CAAC,EAAE;gBAAEC,MAAM,EAAE;YAAI,CAAC,CAAC;QAC3D;QAEA,oCAAA;QACA,MAAMC,WAAW,GAAG,UAAMpB,4IAAc,EAACQ,OAAO,CAACC,MAAM,CAAC;QACxDN,OAAO,CAACC,GAAG,CAAC,uBAAuB,EAAEgB,WAAW,GAAG;YACjDC,EAAE,EAAED,WAAW,CAACC,EAAE;YAClBX,KAAK,EAAEU,WAAW,CAACV,KAAK;YACxBC,IAAI,EAAES,WAAW,CAACT,IAAI;YACtBW,SAAS,EAAE,CAAC,CAACF,WAAW,CAACR,MAAM;YAC/BA,MAAM,EAAEQ,WAAW,CAACR,MAAAA;QACtB,CAAC,GAAG,MAAM,CAAC;QAEX,IAAI,CAACQ,WAAW,EAAE;YAChBjB,OAAO,CAACC,GAAG,CAAC,4CAA4C,CAAC;YACzD,OAAON,gJAAY,CAACmB,IAAI,CAAC;gBAAEC,IAAI,EAAE;YAAK,CAAC,EAAE;gBAAEC,MAAM,EAAE;YAAI,CAAC,CAAC;QAC3D;QAEA,MAAMI,QAAQ,GAAG;YACfF,EAAE,EAAED,WAAW,CAACC,EAAE;YAClBX,KAAK,EAAEU,WAAW,CAACV,KAAK;YACxBC,IAAI,EAAES,WAAW,CAACT,IAAI;YACtBC,MAAM,EAAEQ,WAAW,CAACR,MAAM;YAC1BG,IAAI,EAAEK,WAAW,CAACL,IAAAA;QACpB,CAAC;QAEDZ,OAAO,CAACC,GAAG,CAAC,kDAAkD,EAAE;YAC9D,GAAGmB,QAAQ;YACXV,YAAY,EAAEU,QAAQ,CAACX,MAAM,EAAEE,MAAM,IAAI;QAC3C,CAAC,CAAC;QAEF,OAAOhB,gJAAY,CAACmB,IAAI,CAAC;YACvBC,IAAI,EAAEK;QACR,CAAC,CAAC;IACJ,CAAC,CAAC,OAAOC,KAAK,EAAE;QACdrB,OAAO,CAACqB,KAAK,CAAC,0BAA0B,EAAEA,KAAK,CAAC;QAChD,OAAO1B,gJAAY,CAACmB,IAAI,CAAC;YAAEC,IAAI,EAAE;QAAK,CAAC,EAAE;YAAEC,MAAM,EAAE;QAAI,CAAC,CAAC;IAC3D;AACF","ignoreList":[],"debugId":null}}]
}