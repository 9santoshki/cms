{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/connection.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\n// Create a connection pool\nconst pool = new Pool({\n  host: process.env.DB_HOST || 'localhost',\n  port: parseInt(process.env.DB_PORT || '5432'),\n  database: process.env.DB_NAME || 'cmsdb',\n  user: process.env.DB_USER || 'sk',\n  password: process.env.DB_PASSWORD || 'sk',\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected error on idle client', err);\n  process.exit(-1);\n});\n\nexport const query = async (text: string, params?: any[]) => {\n  const start = Date.now();\n  try {\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    console.log('Executed query', { text, duration, rows: res.rowCount });\n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n};\n\nexport const getClient = async (): Promise<PoolClient> => {\n  const client = await pool.connect();\n  return client;\n};\n\nexport default pool;\n"],"names":["Pool","PoolClient","pool","host","process","env","DB_HOST","port","parseInt","DB_PORT","database","DB_NAME","user","DB_USER","password","DB_PASSWORD","max","idleTimeoutMillis","connectionTimeoutMillis","on","err","console","error","exit","query","text","params","start","Date","now","res","duration","log","rows","rowCount","getClient","Promise","client","connect"],"mappings":";;;;;;;;AAAA,SAASA,IAAI,EAAEC,UAAU,QAAQ,IAAI;;;;;;AAErC,2BAAA;AACA,MAAMC,IAAI,GAAG,IAAIF,4GAAI,CAAC;IACpBG,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,OAAO,IAAI,WAAW;IACxCC,IAAI,EAAEC,QAAQ,CAACJ,OAAO,CAACC,GAAG,CAACI,OAAO,IAAI,MAAM,CAAC;IAC7CC,QAAQ,EAAEN,OAAO,CAACC,GAAG,CAACM,OAAO,IAAI,OAAO;IACxCC,IAAI,EAAER,OAAO,CAACC,GAAG,CAACQ,OAAO,IAAI,IAAI;IACjCC,QAAQ,EAAEV,OAAO,CAACC,GAAG,CAACU,WAAW,IAAI,IAAI;IACzCC,GAAG,EAAE,EAAE;IACPC,iBAAiB,EAAE,KAAK;IACxBC,uBAAuB,EAAE;AAC3B,CAAC,CAAC;AAEFhB,IAAI,CAACiB,EAAE,CAAC,OAAO,GAAGC,GAAG,IAAK;IACxBC,OAAO,CAACC,KAAK,CAAC,iCAAiC,EAAEF,GAAG,CAAC;IACrDhB,OAAO,CAACmB,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEK,MAAMC,KAAK,GAAG,MAAAA,CAAOC,IAAI,EAAE,AAAQC,MAAF,AAAgB,CAAP,EAAE,GAAG,EAAE,KAAK;IAC3D,MAAMC,KAAK,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC;IACxB,IAAI;QACF,MAAMC,GAAG,GAAG,MAAM5B,IAAI,CAACsB,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;QAC1C,MAAMK,QAAQ,GAAGH,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGF,KAAK;QACnCN,OAAO,CAACW,GAAG,CAAC,gBAAgB,EAAE;YAAEP,IAAI;YAAEM,QAAQ;YAAEE,IAAI,EAAEH,GAAG,CAACI,QAAAA;QAAS,CAAC,CAAC;QACrE,OAAOJ,GAAG;IACZ,CAAC,CAAC,OAAOR,KAAK,EAAE;QACdD,OAAO,CAACC,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;QAC7C,MAAMA,KAAK;IACb;AACF,CAAC;AAEM,MAAMa,SAAS,GAAG,MAAAA,CAAA,CAAQ,EAAEC,OAAO,CAACnC,UAAU,CAAC,IAAI;IACxD,MAAMoC,MAAM,GAAG,MAAMnC,IAAI,CAACoC,OAAO,CAAC,CAAC;IACnC,OAAOD,MAAM;AACf,CAAC;uCAEcnC,IAAI","ignoreList":[],"debugId":null}},
    {"offset": {"line": 139, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/auth.ts"],"sourcesContent":["import { query } from './connection';\nimport { cookies, headers } from 'next/headers';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\nconst SESSION_COOKIE_NAME = 'cms-session';\nconst SESSION_DURATION_DAYS = 30; // 30 days for persistent login\n\nexport interface UserProfile {\n  id: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: 'customer' | 'moderator' | 'admin';\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface SessionData {\n  userId: string;\n  email: string;\n  name: string;\n  avatar?: string;\n  role: string;\n  sessionId?: string; // Database session ID\n}\n\nexport interface DBSession {\n  id: string;\n  user_id: string;\n  session_token: string;\n  refresh_token?: string;\n  user_agent?: string;\n  ip_address?: string;\n  expires_at: string;\n  created_at: string;\n  updated_at: string;\n  last_activity: string;\n}\n\n// Create or update user from Google OAuth\nexport const upsertUserFromGoogle = async (googleUser: {\n  id: string;\n  email: string;\n  name: string;\n  picture?: string;\n}): Promise<UserProfile> => {\n  // Check if user exists\n  const existingUser = await query(\n    'SELECT * FROM users WHERE email = $1',\n    [googleUser.email]\n  );\n\n  let userId: string;\n\n  if (existingUser.rows.length > 0) {\n    // Update existing user\n    userId = existingUser.rows[0].id;\n    await query(\n      `UPDATE users\n       SET name = $1, avatar = $2, google_id = $3, updated_at = NOW()\n       WHERE id = $4`,\n      [googleUser.name, googleUser.picture, googleUser.id, userId]\n    );\n  } else {\n    // Create new user\n    const newUser = await query(\n      `INSERT INTO users (email, name, avatar, google_id, role)\n       VALUES ($1, $2, $3, $4, 'customer')\n       RETURNING id`,\n      [googleUser.email, googleUser.name, googleUser.picture, googleUser.id]\n    );\n    userId = newUser.rows[0].id;\n  }\n\n  // Get the complete user profile\n  const userProfile = await getUserProfile(userId);\n  if (!userProfile) {\n    throw new Error('Failed to create or fetch user profile');\n  }\n\n  return userProfile;\n};\n\n// Get user profile by ID\nexport const getUserProfile = async (userId: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE id = $1',\n    [userId]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Get user profile by email\nexport const getUserByEmail = async (email: string): Promise<UserProfile | null> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users WHERE email = $1',\n    [email]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Create session token\nexport const createSessionToken = (user: UserProfile): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: '7d' });\n};\n\n// Verify session token\nexport const verifySessionToken = (token: string): SessionData | null => {\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as SessionData;\n    return decoded;\n  } catch (error) {\n    console.error('Invalid token:', error);\n    return null;\n  }\n};\n\n// Set session cookie\nexport const setSessionCookie = async (token: string) => {\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7, // 7 days\n    path: '/',\n  });\n};\n\n// Get session from cookie\nexport const getSessionFromCookie = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    return null;\n  }\n\n  return verifySessionToken(sessionCookie.value);\n};\n\n// Clear session cookie\nexport const clearSessionCookie = async () => {\n  const cookieStore = await cookies();\n  cookieStore.delete(SESSION_COOKIE_NAME);\n};\n\n// Update user role (admin only)\nexport const updateUserRole = async (\n  userId: string,\n  newRole: 'customer' | 'moderator' | 'admin'\n): Promise<void> => {\n  await query(\n    'UPDATE users SET role = $1, updated_at = NOW() WHERE id = $2',\n    [newRole, userId]\n  );\n};\n\n// Get all user profiles (admin only)\nexport const getAllUserProfiles = async (): Promise<UserProfile[]> => {\n  const result = await query(\n    'SELECT id, email, name, avatar, role, created_at, updated_at FROM users ORDER BY created_at DESC'\n  );\n\n  return result.rows;\n};\n\n// Update user profile\nexport const updateUserProfile = async (\n  userId: string,\n  updates: { name?: string; avatar?: string }\n): Promise<UserProfile | null> => {\n  const fields: string[] = [];\n  const values: any[] = [];\n  let paramCount = 1;\n\n  if (updates.name !== undefined) {\n    fields.push(`name = $${paramCount++}`);\n    values.push(updates.name);\n  }\n\n  if (updates.avatar !== undefined) {\n    fields.push(`avatar = $${paramCount++}`);\n    values.push(updates.avatar);\n  }\n\n  if (fields.length === 0) {\n    return getUserProfile(userId);\n  }\n\n  fields.push(`updated_at = NOW()`);\n  values.push(userId);\n\n  await query(\n    `UPDATE users SET ${fields.join(', ')} WHERE id = $${paramCount}`,\n    values\n  );\n\n  return getUserProfile(userId);\n};\n\n// ============================================================================\n// SESSION MANAGEMENT (Database-backed persistent sessions)\n// ============================================================================\n\n// Generate secure random token\nconst generateSecureToken = (): string => {\n  return crypto.randomBytes(32).toString('hex');\n};\n\n// Get request metadata (user agent, IP)\nconst getRequestMetadata = async () => {\n  try {\n    const headersList = await headers();\n    const userAgent = (await headersList).get('user-agent') || undefined;\n    const forwardedFor = (await headersList).get('x-forwarded-for');\n    const realIp = (await headersList).get('x-real-ip');\n    const ipAddress = forwardedFor?.split(',')[0] || realIp || undefined;\n\n    return { userAgent, ipAddress };\n  } catch (error) {\n    return { userAgent: undefined, ipAddress: undefined };\n  }\n};\n\n// Create a new session in the database\nexport const createSession = async (\n  user: UserProfile,\n  rememberMe: boolean = true\n): Promise<{ sessionToken: string; refreshToken: string; dbSession: DBSession }> => {\n  const sessionToken = generateSecureToken();\n  const refreshToken = generateSecureToken();\n  const { userAgent, ipAddress } = await getRequestMetadata();\n\n  // Calculate expiration based on remember me option\n  const durationDays = rememberMe ? SESSION_DURATION_DAYS : 1; // 30 days or 1 day\n  const expiresAt = new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000);\n\n  const result = await query(\n    `INSERT INTO sessions (user_id, session_token, refresh_token, user_agent, ip_address, expires_at)\n     VALUES ($1, $2, $3, $4, $5, $6)\n     RETURNING *`,\n    [user.id, sessionToken, refreshToken, userAgent, ipAddress, expiresAt]\n  );\n\n  return {\n    sessionToken,\n    refreshToken,\n    dbSession: result.rows[0]\n  };\n};\n\n// Get session from database by token\nexport const getSessionFromDB = async (sessionToken: string): Promise<DBSession | null> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE session_token = $1\n     AND expires_at > NOW()`,\n    [sessionToken]\n  );\n\n  if (result.rows.length === 0) {\n    return null;\n  }\n\n  return result.rows[0];\n};\n\n// Update session activity timestamp\nexport const updateSessionActivity = async (sessionId: string): Promise<void> => {\n  await query(\n    'UPDATE sessions SET last_activity = NOW() WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Delete a specific session\nexport const deleteSession = async (sessionToken: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE session_token = $1',\n    [sessionToken]\n  );\n};\n\n// Delete all sessions for a user\nexport const deleteUserSessions = async (userId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE user_id = $1',\n    [userId]\n  );\n};\n\n// Delete a specific session by ID\nexport const deleteSessionById = async (sessionId: string): Promise<void> => {\n  await query(\n    'DELETE FROM sessions WHERE id = $1',\n    [sessionId]\n  );\n};\n\n// Clean up expired sessions\nexport const cleanupExpiredSessions = async (): Promise<number> => {\n  const result = await query('SELECT cleanup_expired_sessions()');\n  return result.rows[0].cleanup_expired_sessions;\n};\n\n// Get all active sessions for a user\nexport const getUserSessions = async (userId: string): Promise<DBSession[]> => {\n  const result = await query(\n    `SELECT * FROM sessions\n     WHERE user_id = $1\n     AND expires_at > NOW()\n     ORDER BY last_activity DESC`,\n    [userId]\n  );\n\n  return result.rows;\n};\n\n// Enhanced session token creation with database session ID\nexport const createSessionTokenWithDB = (user: UserProfile, sessionId: string): string => {\n  const sessionData: SessionData = {\n    userId: user.id,\n    email: user.email,\n    name: user.name,\n    avatar: user.avatar,\n    role: user.role,\n    sessionId: sessionId, // Include DB session ID in JWT\n  };\n\n  return jwt.sign(sessionData, JWT_SECRET, { expiresIn: `${SESSION_DURATION_DAYS}d` });\n};\n\n// Enhanced session validation (checks both JWT and database)\nexport const validateSession = async (token: string): Promise<SessionData | null> => {\n  // First verify JWT\n  const jwtData = verifySessionToken(token);\n  if (!jwtData) {\n    return null;\n  }\n\n  // If JWT has session ID, verify against database\n  if (jwtData.sessionId) {\n    const dbSession = await query(\n      'SELECT * FROM sessions WHERE id = $1 AND expires_at > NOW()',\n      [jwtData.sessionId]\n    );\n\n    if (dbSession.rows.length === 0) {\n      // Session was invalidated in database\n      return null;\n    }\n\n    // Update last activity\n    await updateSessionActivity(jwtData.sessionId);\n  }\n\n  return jwtData;\n};\n\n// Enhanced get session from cookie with database validation\nexport const getSessionFromCookieWithDB = async (): Promise<SessionData | null> => {\n  const cookieStore = await cookies();\n\n  // Debug: Log all available cookies\n  const allCookies = cookieStore.getAll();\n  console.log('ðŸ” Available cookies:', allCookies.map(c => c.name));\n\n  const sessionCookie = cookieStore.get(SESSION_COOKIE_NAME);\n\n  if (!sessionCookie) {\n    console.log('âŒ getSessionFromCookieWithDB: No session cookie found with name:', SESSION_COOKIE_NAME);\n    return null;\n  }\n\n  console.log('âœ… getSessionFromCookieWithDB: Found session cookie, validating...');\n  // Validate against database as well\n  return validateSession(sessionCookie.value);\n};\n\n// Enhanced set session cookie with longer duration\nexport const setSessionCookieWithDB = async (token: string, rememberMe: boolean = true) => {\n  const cookieStore = await cookies();\n  const maxAge = rememberMe\n    ? 60 * 60 * 24 * SESSION_DURATION_DAYS  // 30 days\n    : 60 * 60 * 24; // 1 day\n\n  cookieStore.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: maxAge,\n    path: '/',\n  });\n\n  console.log('setSessionCookieWithDB: Cookie set successfully, maxAge:', maxAge);\n};\n\n// Enhanced logout that clears both cookie and database session\nexport const logoutSession = async (): Promise<void> => {\n  const session = await getSessionFromCookieWithDB();\n\n  // Clear cookie\n  await clearSessionCookie();\n\n  // Delete from database if session ID exists\n  if (session?.sessionId) {\n    await deleteSessionById(session.sessionId);\n  }\n};\n"],"names":["query","cookies","headers","jwt","crypto","JWT_SECRET","process","env","SESSION_COOKIE_NAME","SESSION_DURATION_DAYS","UserProfile","id","email","name","avatar","role","created_at","updated_at","SessionData","userId","sessionId","DBSession","user_id","session_token","refresh_token","user_agent","ip_address","expires_at","last_activity","upsertUserFromGoogle","googleUser","picture","Promise","existingUser","rows","length","newUser","userProfile","getUserProfile","Error","result","getUserByEmail","createSessionToken","user","sessionData","sign","expiresIn","verifySessionToken","token","decoded","verify","error","console","setSessionCookie","cookieStore","set","httpOnly","secure","NODE_ENV","sameSite","maxAge","path","getSessionFromCookie","sessionCookie","get","value","clearSessionCookie","delete","updateUserRole","newRole","getAllUserProfiles","updateUserProfile","updates","fields","values","paramCount","undefined","push","join","generateSecureToken","randomBytes","toString","getRequestMetadata","headersList","userAgent","forwardedFor","realIp","ipAddress","split","createSession","rememberMe","sessionToken","refreshToken","dbSession","durationDays","expiresAt","Date","now","getSessionFromDB","updateSessionActivity","deleteSession","deleteUserSessions","deleteSessionById","cleanupExpiredSessions","cleanup_expired_sessions","getUserSessions","createSessionTokenWithDB","validateSession","jwtData","getSessionFromCookieWithDB","allCookies","getAll","log","map","c","setSessionCookieWithDB","logoutSession","session"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 501, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/lib/db/appointments.ts"],"sourcesContent":["import { query } from './connection';\n\nexport interface Appointment {\n  id: string;\n  user_id?: string;\n  appointment_date: string;\n  service_type?: string;\n  status: 'pending' | 'scheduled' | 'confirmed' | 'completed' | 'cancelled';\n  notes?: string;\n  guest_name?: string;\n  guest_email?: string;\n  guest_phone?: string;\n  created_at?: string;\n  updated_at?: string;\n  user_name?: string;\n  user_email?: string;\n}\n\nexport async function createAppointment(appointment: {\n  user_id?: string;\n  appointment_date: string;\n  service_type?: string;\n  notes?: string;\n  guest_name?: string;\n  guest_email?: string;\n  guest_phone?: string;\n}): Promise<Appointment> {\n  const result = await query(\n    `INSERT INTO appointments (user_id, appointment_date, service_type, notes, status, guest_name, guest_email, guest_phone)\n     VALUES ($1, $2, $3, $4, 'pending', $5, $6, $7)\n     RETURNING *`,\n    [\n      appointment.user_id || null,\n      appointment.appointment_date,\n      appointment.service_type || null,\n      appointment.notes || null,\n      appointment.guest_name || null,\n      appointment.guest_email || null,\n      appointment.guest_phone || null,\n    ]\n  );\n  return result.rows[0];\n}\n\nexport async function getAppointmentById(id: string): Promise<Appointment | null> {\n  const result = await query('SELECT * FROM appointments WHERE id = $1', [id]);\n  return result.rows[0] || null;\n}\n\nexport async function getAppointmentsByUserId(userId: string): Promise<Appointment[]> {\n  const result = await query(\n    `SELECT * FROM appointments WHERE user_id = $1 ORDER BY appointment_date DESC`,\n    [userId]\n  );\n  return result.rows;\n}\n\nexport async function getAllAppointments(): Promise<Appointment[]> {\n  const result = await query(\n    `SELECT\n      a.*,\n      COALESCE(a.guest_email, u.email) as user_email,\n      COALESCE(a.guest_name, u.name) as user_name,\n      a.guest_phone as user_phone\n     FROM appointments a\n     LEFT JOIN users u ON a.user_id = u.id\n     ORDER BY a.created_at DESC`\n  );\n  return result.rows;\n}\n\nexport async function updateAppointment(\n  id: string,\n  updates: Partial<Appointment>\n): Promise<Appointment | null> {\n  const fields: string[] = [];\n  const values: any[] = [];\n  let paramCount = 1;\n\n  Object.entries(updates).forEach(([key, value]) => {\n    if (value !== undefined && key !== 'id' && key !== 'user_id') {\n      fields.push(`${key} = $${paramCount++}`);\n      values.push(value);\n    }\n  });\n\n  if (fields.length === 0) {\n    return getAppointmentById(id);\n  }\n\n  values.push(id);\n\n  const result = await query(\n    `UPDATE appointments SET ${fields.join(', ')}, updated_at = NOW() WHERE id = $${paramCount} RETURNING *`,\n    values\n  );\n\n  return result.rows[0] || null;\n}\n\nexport async function deleteAppointment(id: string): Promise<boolean> {\n  const result = await query('DELETE FROM appointments WHERE id = $1', [id]);\n  return result.rowCount ? result.rowCount > 0 : false;\n}\n\nexport async function updateAppointmentStatus(\n  id: string,\n  status: Appointment['status']\n): Promise<Appointment | null> {\n  const result = await query(\n    `UPDATE appointments SET status = $1, updated_at = NOW() WHERE id = $2 RETURNING *`,\n    [status, id]\n  );\n  return result.rows[0] || null;\n}\n"],"names":["query","Appointment","id","user_id","appointment_date","service_type","status","notes","guest_name","guest_email","guest_phone","created_at","updated_at","user_name","user_email","createAppointment","appointment","Promise","result","rows","getAppointmentById","getAppointmentsByUserId","userId","getAllAppointments","updateAppointment","updates","Partial","fields","values","paramCount","Object","entries","forEach","key","value","undefined","push","length","join","deleteAppointment","rowCount","updateAppointmentStatus"],"mappings":"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","ignoreList":[],"debugId":null}},
    {"offset": {"line": 597, "column": 0}, "map": {"version":3,"sources":["file:///Users/sk/personal/proj/cms/src/app/api/appointments/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getSessionFromCookie } from '@/lib/db/auth';\nimport {\n  getAppointmentById,\n  updateAppointment,\n  deleteAppointment,\n} from '@/lib/db/appointments';\n\n// Verify user session and get user ID\nasync function getUserIdFromRequest(request: NextRequest) {\n  try {\n    const session = await getSessionFromCookie();\n    return session?.userId || null;\n  } catch (error) {\n    console.error('Error getting user session:', error);\n    return null;\n  }\n}\n\nexport async function GET(\n  request: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  try {\n    const userId = await getUserIdFromRequest(request);\n\n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const params = await context.params;\n    const { id } = params;\n\n    const appointment = await getAppointmentById(id);\n\n    if (!appointment) {\n      return NextResponse.json(\n        { success: false, error: 'Appointment not found' },\n        { status: 404 }\n      );\n    }\n\n    // Ensure user can only access their own appointments\n    if (appointment.user_id !== userId) {\n      return NextResponse.json(\n        { success: false, error: 'Appointment not found' },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: appointment,\n    });\n  } catch (error) {\n    console.error('Error fetching appointment:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error',\n      },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PUT(\n  request: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  try {\n    const userId = await getUserIdFromRequest(request);\n\n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const params = await context.params;\n    const { id } = params;\n    const { status, notes, service_type, appointment_date } = await request.json();\n\n    // Verify the appointment exists and belongs to the user\n    const existingAppointment = await getAppointmentById(id);\n\n    if (!existingAppointment || existingAppointment.user_id !== userId) {\n      return NextResponse.json(\n        { success: false, error: 'Appointment not found' },\n        { status: 404 }\n      );\n    }\n\n    // Validate status if provided\n    if (status && !['scheduled', 'completed', 'cancelled'].includes(status)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid status' },\n        { status: 400 }\n      );\n    }\n\n    // Prepare update data\n    const updateData: any = {};\n    if (status) updateData.status = status;\n    if (notes !== undefined) updateData.notes = notes;\n    if (service_type) updateData.service_type = service_type;\n    if (appointment_date) updateData.appointment_date = appointment_date;\n\n    const updatedAppointment = await updateAppointment(id, updateData);\n\n    if (!updatedAppointment) {\n      return NextResponse.json(\n        { success: false, error: 'Failed to update appointment' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: updatedAppointment,\n    });\n  } catch (error) {\n    console.error('Error updating appointment:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error',\n      },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  try {\n    const userId = await getUserIdFromRequest(request);\n\n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    const params = await context.params;\n    const { id } = params;\n\n    // Verify the appointment exists and belongs to the user\n    const existingAppointment = await getAppointmentById(id);\n\n    if (!existingAppointment || existingAppointment.user_id !== userId) {\n      return NextResponse.json(\n        { success: false, error: 'Appointment not found' },\n        { status: 404 }\n      );\n    }\n\n    // Only allow deletion for scheduled or cancelled appointments\n    if (existingAppointment.status === 'completed') {\n      return NextResponse.json(\n        { success: false, error: 'Cannot delete a completed appointment' },\n        { status: 400 }\n      );\n    }\n\n    const success = await deleteAppointment(id);\n\n    if (!success) {\n      return NextResponse.json(\n        { success: false, error: 'Failed to delete appointment' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'Appointment deleted successfully',\n    });\n  } catch (error) {\n    console.error('Error deleting appointment:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Internal server error',\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["NextRequest","NextResponse","getSessionFromCookie","getAppointmentById","updateAppointment","deleteAppointment","getUserIdFromRequest","request","session","userId","error","console","GET","context","params","Promise","id","json","success","status","appointment","user_id","data","PUT","notes","service_type","appointment_date","existingAppointment","includes","updateData","undefined","updatedAppointment","DELETE","message"],"mappings":"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","ignoreList":[],"debugId":null}}]
}