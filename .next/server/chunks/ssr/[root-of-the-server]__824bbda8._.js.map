{"version":3,"sources":["turbopack:///[project]/src/app/checkout/page.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/src/app/checkout/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/checkout/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/checkout/page.tsx\",\n    \"default\",\n);\n","'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAppContext } from '@/context/AppContext';\nimport { useCartStore } from '@/store/cartStore';\nimport { apiClient } from '@/lib/api';\nimport { calculateCartTotal, calculateShippingCost } from '@/utils/cartUtils';\nimport Header from '@/components/Header';\nimport Footer from '@/components/Footer';\nimport {\n  CheckoutContainer,\n  CheckoutHeader,\n  CheckoutContent,\n  ShippingSection,\n  FormGrid,\n  FormField,\n  OrderSummarySection,\n  OrderSummaryCard,\n  OrderItemsList,\n  OrderItem,\n  ItemImage,\n  ItemDetails,\n  OrderSummaryDetails,\n  PayButton,\n  ErrorMessage,\n  SecurityNote,\n  LoadingScreen\n} from '@/styles/CheckoutStyles';\n\nconst CheckoutPage = () => {\n  const router = useRouter();\n  const { user } = useAppContext();\n  const cartItems = useCartStore(state => state.items);\n  const getTotalPrice = useCartStore(state => state.getTotalPrice);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [shippingAddress, setShippingAddress] = useState({\n    name: user?.name || '',\n    email: user?.email || '',\n    phone: '',\n    address: '',\n    city: '',\n    state: '',\n    zipCode: '',\n    country: 'India'\n  });\n\n  const subtotal = calculateCartTotal(cartItems);\n  const shipping = calculateShippingCost(subtotal);\n  const total = subtotal + shipping;\n\n  // Check if user is logged in\n  useEffect(() => {\n    if (!user) {\n      router.push('/auth?redirect=/checkout');\n    }\n  }, [user, router]);\n\n  // Update shipping address when user data becomes available\n  useEffect(() => {\n    if (user) {\n      setShippingAddress(prev => ({\n        ...prev,\n        name: user.name || prev.name,\n        email: user.email || prev.email\n      }));\n    }\n  }, [user]);\n\n  // Handle input changes for shipping address\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    const { name, value } = e.target;\n    setShippingAddress(prev => ({\n      ...prev,\n      [name]: value\n    }));\n  };\n\n  // Handle form submission\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setLoading(true);\n    setError(null);\n\n    try {\n      // Verify cart is not empty\n      if (cartItems.length === 0) {\n        throw new Error('Cannot checkout with an empty cart');\n      }\n\n      // Create checkout session with Razorpay\n      const response = await apiClient.createCheckoutSession({\n        items: cartItems.map(item => ({\n          product_id: item.product_id,\n          quantity: item.quantity,\n          price: typeof item.price === 'number' ? item.price : parseFloat(item.price || '0'), // Ensure price is a number\n          name: item.name\n        })),\n        shipping_address: shippingAddress\n      });\n\n      if (!response.success || !response.data) {\n        throw new Error(response.error || 'Failed to create checkout session');\n      }\n\n      // Initialize Razorpay checkout\n      const options = {\n        key: process.env.NEXT_PUBLIC_RAZORPAY_KEY_ID!, // Should be in environment variables\n        amount: response.data.amount, // Amount in paise\n        currency: response.data.currency,\n        name: 'Colour My Space',\n        description: 'Furniture Purchase',\n        order_id: response.data.razorpay_order_id,\n        handler: async (response: any) => {\n          try {\n            // Verify payment with our backend after successful payment\n            const verifyResponse = await apiClient.verifyPayment({\n              razorpay_order_id: response.razorpay_order_id,\n              razorpay_payment_id: response.razorpay_payment_id,\n              razorpay_signature: response.razorpay_signature\n            });\n\n            if (!verifyResponse.success || !verifyResponse.data) {\n              throw new Error(verifyResponse.error || 'Payment verification failed');\n            }\n\n            if (verifyResponse.success && verifyResponse.data) {\n              // Payment successful - clear cart and redirect to success page\n              import('@/store/cartStore').then((module) => {\n                module.useCartStore.getState().clearCart();\n              });\n              router.push(`/checkout/success?orderId=${verifyResponse.data.order_id}`);\n            } else {\n              setError('Payment verification failed. Please contact support.');\n            }\n          } catch (verifyError) {\n            console.error('Payment verification error:', verifyError);\n            setError('Payment verification failed. Please contact support.');\n          }\n        },\n        prefill: {\n          name: shippingAddress.name,\n          email: shippingAddress.email,\n          contact: shippingAddress.phone\n        },\n        theme: {\n          color: '#F59E0B' // Amber color to match our theme\n        }\n      };\n\n      // Load Razorpay checkout\n      const script = document.createElement('script');\n      script.src = 'https://checkout.razorpay.com/v1/checkout.js';\n      script.onload = () => {\n        // @ts-ignore - Razorpay checkout is added to window by the script\n        const rzp = new window.Razorpay(options);\n        rzp.open();\n      };\n      script.onerror = () => {\n        setError('Failed to load payment gateway. Please try again.');\n        setLoading(false);\n      };\n      document.body.appendChild(script);\n    } catch (err: any) {\n      console.error('Checkout error:', err);\n      setError(err.message || 'An error occurred during checkout');\n      setLoading(false);\n    }\n  };\n\n  if (!user) {\n    return (\n      <LoadingScreen>\n        <div className=\"loading-content\">\n          <div className=\"spinner\"></div>\n          <p>Redirecting to login...</p>\n        </div>\n      </LoadingScreen>\n    );\n  }\n\n  return (\n    <CheckoutContainer>\n      <Header activePage=\"checkout\" />\n\n      <CheckoutHeader>\n        <h1>Checkout</h1>\n        <p>Complete your order securely</p>\n      </CheckoutHeader>\n\n      <CheckoutContent>\n        {/* Shipping Information */}\n        <ShippingSection>\n          <h2>Shipping Information</h2>\n\n          <form onSubmit={handleSubmit}>\n            <FormGrid>\n              <FormField>\n                <label htmlFor=\"name\">Full Name *</label>\n                <input\n                  type=\"text\"\n                  name=\"name\"\n                  id=\"name\"\n                  value={shippingAddress.name}\n                  onChange={handleInputChange}\n                  required\n                />\n              </FormField>\n\n              <FormField>\n                <label htmlFor=\"email\">Email Address *</label>\n                <input\n                  type=\"email\"\n                  name=\"email\"\n                  id=\"email\"\n                  value={shippingAddress.email}\n                  onChange={handleInputChange}\n                  required\n                  readOnly={!!user?.email}\n                />\n              </FormField>\n\n              <FormField>\n                <label htmlFor=\"phone\">Phone Number *</label>\n                <input\n                  type=\"tel\"\n                  name=\"phone\"\n                  id=\"phone\"\n                  value={shippingAddress.phone}\n                  onChange={handleInputChange}\n                  required\n                />\n              </FormField>\n\n              <FormField $fullWidth>\n                <label htmlFor=\"address\">Street Address *</label>\n                <input\n                  type=\"text\"\n                  name=\"address\"\n                  id=\"address\"\n                  value={shippingAddress.address}\n                  onChange={handleInputChange}\n                  required\n                />\n              </FormField>\n\n              <FormField>\n                <label htmlFor=\"city\">City *</label>\n                <input\n                  type=\"text\"\n                  name=\"city\"\n                  id=\"city\"\n                  value={shippingAddress.city}\n                  onChange={handleInputChange}\n                  required\n                />\n              </FormField>\n\n              <FormField>\n                <label htmlFor=\"state\">State / Province *</label>\n                <input\n                  type=\"text\"\n                  name=\"state\"\n                  id=\"state\"\n                  value={shippingAddress.state}\n                  onChange={handleInputChange}\n                  required\n                />\n              </FormField>\n\n              <FormField>\n                <label htmlFor=\"zipCode\">ZIP / Postal Code *</label>\n                <input\n                  type=\"text\"\n                  name=\"zipCode\"\n                  id=\"zipCode\"\n                  value={shippingAddress.zipCode}\n                  onChange={handleInputChange}\n                  required\n                />\n              </FormField>\n\n              <FormField>\n                <label htmlFor=\"country\">Country</label>\n                <input\n                  type=\"text\"\n                  name=\"country\"\n                  id=\"country\"\n                  value={shippingAddress.country}\n                  onChange={handleInputChange}\n                  required\n                  readOnly\n                />\n              </FormField>\n            </FormGrid>\n\n            {error && <ErrorMessage>{error}</ErrorMessage>}\n          </form>\n        </ShippingSection>\n\n        {/* Order Summary */}\n        <OrderSummarySection>\n          <OrderSummaryCard>\n            <h2>Order Summary</h2>\n\n            <OrderItemsList>\n              {cartItems.map((item, index) => {\n                const uniqueKey = item.product_id ? `prod-${item.product_id}` :\n                                 item.id ? `item-${item.id}-${index}` :\n                                 `idx-${index}`;\n\n                // Check if image_url is valid (not a placeholder URL)\n                const hasValidImage = item.image_url &&\n                                     !item.image_url.includes('r2-placeholder.com');\n\n                return (\n                  <OrderItem key={uniqueKey}>\n                    <ItemImage>\n                      {hasValidImage ? (\n                        <img\n                          src={item.image_url}\n                          alt={item.name}\n                          style={{\n                            width: '100%',\n                            height: '100%',\n                            objectFit: 'cover'\n                          }}\n                          onError={(e) => {\n                            // If image fails to load, show placeholder\n                            e.currentTarget.style.display = 'none';\n                            if (e.currentTarget.nextSibling) {\n                              (e.currentTarget.nextSibling as HTMLElement).style.display = 'flex';\n                            }\n                          }}\n                        />\n                      ) : null}\n                      <div style={{\n                        width: '100%',\n                        height: '100%',\n                        backgroundColor: '#e8d5c4',\n                        display: hasValidImage ? 'none' : 'flex',\n                        alignItems: 'center',\n                        justifyContent: 'center',\n                        fontSize: '20px',\n                        color: '#c19a6b'\n                      }}>\n                        <i className=\"fas fa-image\"></i>\n                      </div>\n                    </ItemImage>\n\n                    <ItemDetails>\n                      <h3>{item.name}</h3>\n                      <div className=\"price-qty\">\n                        <span className=\"qty\">Qty: {item.quantity}</span>\n                        <span className=\"price\">\n                          ₹{(typeof item.price === 'number' ? item.price : parseFloat(item.price || '0')).toLocaleString()}\n                        </span>\n                      </div>\n                    </ItemDetails>\n                  </OrderItem>\n                );\n              })}\n            </OrderItemsList>\n\n            <OrderSummaryDetails>\n              <div className=\"summary-row\">\n                <span>Subtotal</span>\n                <span>₹{subtotal.toLocaleString()}</span>\n              </div>\n              <div className=\"summary-row\">\n                <span>Shipping</span>\n                <span>{shipping === 0 ? 'FREE' : `₹${shipping.toLocaleString()}`}</span>\n              </div>\n              <div className=\"summary-row total\">\n                <span>Total</span>\n                <span>₹{total.toLocaleString()}</span>\n              </div>\n            </OrderSummaryDetails>\n\n            <PayButton\n              type=\"submit\"\n              disabled={loading || cartItems.length === 0}\n              onClick={handleSubmit}\n            >\n              {loading ? (\n                <>\n                  <span className=\"spinner\"></span>\n                  Processing...\n                </>\n              ) : (\n                `Pay ₹${total.toLocaleString()}`\n              )}\n            </PayButton>\n\n            <SecurityNote>\n              <i className=\"fas fa-lock\"></i>\n              Secure payment powered by Razorpay. Your information is encrypted and safe.\n            </SecurityNote>\n          </OrderSummaryCard>\n        </OrderSummarySection>\n      </CheckoutContent>\n\n      <Footer />\n    </CheckoutContainer>\n  );\n};\n\nexport default CheckoutPage;"],"names":["React","useState","useEffect","useRouter","useAppContext","useCartStore","apiClient","calculateCartTotal","calculateShippingCost","Header","Footer","CheckoutContainer","CheckoutHeader","CheckoutContent","ShippingSection","FormGrid","FormField","OrderSummarySection","OrderSummaryCard","OrderItemsList","OrderItem","ItemImage","ItemDetails","OrderSummaryDetails","PayButton","ErrorMessage","SecurityNote","LoadingScreen","CheckoutPage","router","user","cartItems","state","items","getTotalPrice","loading","setLoading","error","setError","shippingAddress","setShippingAddress","name","email","phone","address","city","zipCode","country","subtotal","shipping","total","push","prev","handleInputChange","e","ChangeEvent","HTMLInputElement","HTMLTextAreaElement","value","target","handleSubmit","FormEvent","preventDefault","length","Error","response","createCheckoutSession","map","item","product_id","quantity","price","parseFloat","shipping_address","success","data","options","key","process","env","NEXT_PUBLIC_RAZORPAY_KEY_ID","amount","currency","description","order_id","razorpay_order_id","handler","verifyResponse","verifyPayment","razorpay_payment_id","razorpay_signature","then","module","getState","clearCart","verifyError","console","prefill","contact","theme","color","script","document","createElement","src","onload","rzp","window","Razorpay","open","onerror","body","appendChild","err","message","index","uniqueKey","id","hasValidImage","image_url","includes","width","height","objectFit","currentTarget","style","display","nextSibling","HTMLElement","backgroundColor","alignItems","justifyContent","fontSize","toLocaleString"],"mappings":"iYAEe,CAAA,EAAA,AADf,EAAA,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,2RAA6R,EAC1T,0DACA,8DAHW,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,uQAAyQ,EACtS,sCACA","ignoreList":[0]}